<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AssetMaster Pro Elite | Advanced Investment Empire</title>
    <style>
        :root {
            --primary: #6e45e2;
            --secondary: #88d3ce;
            --accent: #ff6b6b;
            --dark: #0f0f23;
            --darker: #1a1a2e;
            --darkest: #16213e;
            --light: #f8f9fa;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --bronze: #cd7f32;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--dark) 0%, var(--darker) 50%, var(--darkest) 100%);
            color: var(--light);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(110, 69, 226, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(136, 211, 206, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 40% 80%, rgba(255, 107, 107, 0.05) 0%, transparent 30%);
            z-index: -1;
            animation: backgroundMove 20s infinite ease-in-out;
        }

        @keyframes backgroundMove {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(-2%, -1%) rotate(0.5deg); }
            50% { transform: translate(1%, -2%) rotate(-0.3deg); }
            75% { transform: translate(-1%, 1%) rotate(0.2deg); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Enhanced Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 0;
            border-bottom: 2px solid rgba(110, 69, 226, 0.3);
            margin-bottom: 30px;
            background: rgba(26, 26, 46, 0.6);
            border-radius: 20px;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(110, 69, 226, 0.1), transparent);
            animation: headerShine 3s infinite;
        }

        @keyframes headerShine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .logo {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(45deg, var(--primary), var(--secondary), var(--accent));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: flex;
            align-items: center;
            animation: gradientShift 3s ease-in-out infinite;
            text-shadow: 0 0 30px rgba(110, 69, 226, 0.5);
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .logo i {
            margin-right: 15px;
            font-size: 36px;
            filter: drop-shadow(0 0 10px rgba(110, 69, 226, 0.7));
        }

        .header-stats {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .wallet {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            padding: 15px 25px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(110, 69, 226, 0.3);
            backdrop-filter: blur(20px);
        }

        .wallet-amount {
            font-size: 22px;
            font-weight: 700;
            margin-right: 10px;
            color: var(--secondary);
            text-shadow: 0 0 20px rgba(136, 211, 206, 0.5);
        }

        .player-level {
            background: linear-gradient(135deg, var(--gold), var(--warning));
            padding: 10px 20px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.3);
            border: 2px solid var(--gold);
        }

        .level-icon {
            font-size: 20px;
            color: var(--darkest);
        }

        .level-text {
            font-weight: 700;
            color: var(--darkest);
            font-size: 16px;
        }

        .loan-debt-indicator {
            background: linear-gradient(135deg, var(--danger), #ff4757);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        /* Enhanced Sidebar */
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 25px;
        }

        .sidebar {
            background: linear-gradient(135deg, 
                rgba(26, 26, 46, 0.9) 0%, 
                rgba(22, 33, 62, 0.9) 100%);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(110, 69, 226, 0.2);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .player-profile {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .player-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: white;
            box-shadow: 0 8px 30px rgba(110, 69, 226, 0.5);
            border: 4px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .player-avatar::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: avatarShine 3s infinite;
        }

        .player-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .player-networth {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 20px;
            background: linear-gradient(45deg, var(--secondary), var(--primary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 30px rgba(136, 211, 206, 0.5);
        }

        .detailed-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02));
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(110, 69, 226, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(110, 69, 226, 0.3);
            border-color: rgba(110, 69, 226, 0.5);
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-weight: 700;
            font-size: 16px;
            color: var(--secondary);
        }

        .net-worth-breakdown {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(110, 69, 226, 0.2);
        }

        .breakdown-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .breakdown-item:last-child {
            border-bottom: none;
        }

        .breakdown-label {
            font-size: 13px;
            opacity: 0.8;
        }

        .breakdown-value {
            font-weight: 600;
            font-size: 14px;
        }

        .positive-value {
            color: var(--success);
        }

        .negative-value {
            color: var(--danger);
        }

        .badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 25px;
        }

        .badge {
            background: linear-gradient(135deg, rgba(136, 211, 206, 0.2), rgba(110, 69, 226, 0.2));
            color: var(--secondary);
            padding: 6px 12px;
            border-radius: 25px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid var(--secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 10px rgba(136, 211, 206, 0.3);
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 8px;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 15px 18px;
            border-radius: 12px;
            color: var(--light);
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .sidebar-menu a:hover, 
        .sidebar-menu a.active {
            background: linear-gradient(135deg, rgba(110, 69, 226, 0.3), rgba(136, 211, 206, 0.1));
            color: var(--light);
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(110, 69, 226, 0.3);
        }

        .sidebar-menu i {
            margin-right: 12px;
            font-size: 18px;
            width: 20px;
            text-align: center;
        }

        /* Enhanced Main Content */
        .main-content {
            background: linear-gradient(135deg, 
                rgba(26, 26, 46, 0.9) 0%, 
                rgba(22, 33, 62, 0.9) 100%);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(110, 69, 226, 0.2);
            position: relative;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(110, 69, 226, 0.3);
        }

        .section-title {
            font-size: 26px;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .section-actions {
            display: flex;
            gap: 12px;
        }

        /* Enhanced Buttons */
        .btn {
            padding: 12px 20px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn i {
            margin-right: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #5d3ac9);
            color: white;
            box-shadow: 0 6px 20px rgba(110, 69, 226, 0.4);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(110, 69, 226, 0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #218838);
            color: white;
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.6);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #c82333);
            color: white;
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(220, 53, 69, 0.6);
        }

        .btn-outline {
            background: rgba(255, 255, 255, 0.05);
            color: var(--light);
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-outline:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(110, 69, 226, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(110, 69, 226, 0.3);
        }

        /* Enhanced Widgets */
        .dashboard-widgets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .widget {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02));
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(110, 69, 226, 0.2);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .widget:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            border-color: rgba(110, 69, 226, 0.4);
        }

        .widget::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .widget-title {
            font-size: 14px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .widget-value {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(45deg, var(--secondary), var(--primary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .widget-growth {
            font-size: 12px;
            color: var(--success);
            display: flex;
            align-items: center;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 15px;
            background: rgba(40, 167, 69, 0.1);
        }

        .widget-growth.negative {
            color: var(--danger);
            background: rgba(220, 53, 69, 0.1);
        }

        /* Progress Bars */
        .progress-bar {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 15px;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 10px;
            transition: width 0.8s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: progressShine 2s infinite;
        }

        @keyframes progressShine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Enhanced Asset Cards */
        .asset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }

        .asset-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02));
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.4s ease;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(110, 69, 226, 0.2);
            position: relative;
            backdrop-filter: blur(10px);
        }

        .asset-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
            border-color: rgba(110, 69, 226, 0.6);
        }

        .asset-image {
            height: 180px;
            background: linear-gradient(135deg, #3a3a5e 0%, #2a2a4a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            color: rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .asset-details {
            padding: 25px;
        }

        .asset-category {
            font-size: 11px;
            color: var(--secondary);
            margin-bottom: 8px;
            display: inline-block;
            background: rgba(136, 211, 206, 0.15);
            padding: 4px 10px;
            border-radius: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .asset-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--light);
        }

        .asset-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .asset-stat {
            font-size: 13px;
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .asset-price {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 20px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .asset-actions {
            display: flex;
            gap: 12px;
        }

        .btn-asset {
            flex: 1;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
        }

        /* Stock Market Styles */
        .stock-ticker {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 25px;
            overflow: hidden;
            position: relative;
        }

        .ticker-content {
            display: flex;
            gap: 30px;
            animation: scroll 30s linear infinite;
        }

        @keyframes scroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .stock-item {
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
            padding: 5px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .stock-chart {
            height: 300px;
            margin-bottom: 20px;
        }

        /* Trading Marketplace */
        .trade-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .trade-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02));
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(110, 69, 226, 0.2);
            transition: all 0.3s ease;
        }

        .trade-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .trader-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .trader-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        /* Business Empire Styles */
        .business-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .business-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02));
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(110, 69, 226, 0.2);
            transition: all 0.3s ease;
        }

        .business-level {
            background: var(--warning);
            color: var(--darkest);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 10px;
        }

        /* Achievement & Quest Styles */
        .quest-list {
            display: grid;
            gap: 15px;
        }

        .quest-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }

        .quest-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .quest-progress {
            margin-top: 10px;
        }

        .quest-progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .quest-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Insurance & Risk Management */
        .insurance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .insurance-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02));
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(110, 69, 226, 0.2);
        }

        .risk-meter {
            height: 120px;
            width: 120px;
            border-radius: 50%;
            background: conic-gradient(var(--success) 0deg, var(--warning) 120deg, var(--danger) 240deg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            position: relative;
        }

        .risk-meter::before {
            content: '';
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--darkest);
            position: absolute;
        }

        .risk-value {
            font-size: 18px;
            font-weight: 700;
            z-index: 1;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: linear-gradient(135deg, var(--darker) 0%, var(--darkest) 100%);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            position: relative;
            border: 1px solid rgba(110, 69, 226, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 28px;
            cursor: pointer;
            color: var(--light);
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            opacity: 1;
            transform: scale(1.1);
            color: var(--danger);
        }

        .modal-header {
            margin-bottom: 25px;
            text-align: center;
        }

        .modal-header h3 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary);
        }

        .form-input {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: var(--light);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(110, 69, 226, 0.3);
        }

        /* Notifications */
        .notification-toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, var(--darker), var(--darkest));
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            border-left: 4px solid var(--success);
            display: flex;
            align-items: center;
            transform: translateX(120%);
            transition: transform 0.4s ease;
            z-index: 1000;
            max-width: 350px;
            backdrop-filter: blur(20px);
        }

        .notification-toast.show {
            transform: translateX(0);
        }

        .notification-toast.warning {
            border-left-color: var(--warning);
        }

        .notification-toast.error {
            border-left-color: var(--danger);
        }

        .notification-icon {
            font-size: 24px;
            margin-right: 15px;
        }

        .notification-success .notification-icon {
            color: var(--success);
        }

        .notification-warning .notification-icon {
            color: var(--warning);
        }

        .notification-error .notification-icon {
            color: var(--danger);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 320px 1fr;
            }
        }

        @media (max-width: 992px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: 2;
                position: static;
            }

            .header-stats {
                gap: 15px;
            }

            .dashboard-widgets {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
                padding: 20px;
            }

            .header-stats {
                flex-direction: column;
                width: 100%;
            }

            .logo {
                font-size: 24px;
            }

            .section-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .section-actions {
                width: 100%;
                justify-content: center;
            }

            .asset-grid {
                grid-template-columns: 1fr;
            }

            .detailed-stats {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 25px;
                margin: 15px;
            }
        }

        /* Additional animations */
        @keyframes avatarShine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .float {
            animation: float 6s ease-in-out infinite;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeInUp 0.6s ease-out;
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                --light: #f8f9fa;
                --dark: #0f0f23;
                --darker: #1a1a2e;
                --darkest: #16213e;
            }
        }

        /* Level system styling */
        .level-progress {
            margin-top: 10px;
        }

        .level-progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .level-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--warning));
            border-radius: 10px;
            transition: width 0.8s ease;
        }

        .level-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-top: 5px;
            opacity: 0.8;
        }

        /* Enhanced Market Event Banner */
        .market-event-banner {
            background: linear-gradient(135deg, var(--warning), var(--danger));
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: none;
            align-items: center;
            animation: eventPulse 2s infinite;
            box-shadow: 0 5px 25px rgba(255, 193, 7, 0.4);
        }

        .market-event-banner.active {
            display: flex;
        }

        @keyframes eventPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 5px 25px rgba(255, 193, 7, 0.4); }
            50% { transform: scale(1.02); box-shadow: 0 8px 35px rgba(255, 193, 7, 0.6); }
        }

        /* Enhanced Leaderboard */
        .leaderboard-container {
            overflow-x: auto;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.02);
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th {
            padding: 18px;
            text-align: left;
            background: linear-gradient(135deg, rgba(110, 69, 226, 0.2), rgba(136, 211, 206, 0.1));
            font-weight: 700;
            font-size: 16px;
            color: var(--light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .leaderboard-table td {
            padding: 16px 18px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .leaderboard-table tr:hover {
            background: rgba(110, 69, 226, 0.1);
            transform: scale(1.01);
        }

        .player-you {
            background: linear-gradient(135deg, rgba(110, 69, 226, 0.2), rgba(136, 211, 206, 0.1)) !important;
            border: 2px solid var(--primary);
        }

        .rank-badge {
            display: inline-block;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            text-align: center;
            line-height: 32px;
            font-weight: bold;
            margin-right: 12px;
            font-size: 14px;
        }

        .rank-1 .rank-badge {
            background: linear-gradient(135deg, var(--gold), #ffa500);
            color: var(--darkest);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .rank-2 .rank-badge {
            background: linear-gradient(135deg, var(--silver), #a9a9a9);
            color: var(--darkest);
            box-shadow: 0 0 15px rgba(192, 192, 192, 0.5);
        }

        .rank-3 .rank-badge {
            background: linear-gradient(135deg, var(--bronze), #a0522d);
            color: var(--light);
            box-shadow: 0 0 15px rgba(205, 127, 50, 0.5);
        }

        .positive-roi {
            color: var(--success);
            font-weight: 600;
        }

        .negative-roi {
            color: var(--danger);
            font-weight: 600;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- Market Event Banner -->
        <div class="market-event-banner" id="marketEventBanner">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <strong id="marketEventTitle">Market Event</strong>
                <span id="marketEventDescription"></span>
                <div style="font-size: 12px; opacity: 0.9; margin-top: 5px;">
                    Time remaining: <span id="marketEventTimer"></span>
                </div>
            </div>
        </div>

        <header>
            <div class="logo">
                <i class="fas fa-chart-line float"></i>
                <span>AssetMaster Pro Elite</span>
            </div>
            <div class="header-stats">
                <div class="player-level" id="playerLevel">
                    <i class="fas fa-crown level-icon"></i>
                    <div class="level-text">Level <span id="currentLevel">1</span></div>
                </div>
                <div class="wallet">
                    <span class="wallet-amount" id="walletAmount">$0</span>
                    <i class="fas fa-wallet wallet-icon"></i>
                </div>
                <div class="loan-debt-indicator" id="loanDebtIndicator" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Debt: $<span id="debtAmount">0</span></span>
                </div>
            </div>
        </header>

        <div class="main-grid">
            <aside class="sidebar">
                <div class="player-profile">
                    <div class="player-avatar">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <h3 class="player-name" id="playerName">Elite Investor</h3>
                    <div class="player-networth" id="netWorth">$0</div>
                    
                    <div class="level-progress">
                        <div class="level-progress-bar">
                            <div class="level-progress-fill" id="levelProgressFill"></div>
                        </div>
                        <div class="level-info">
                            <span>Level <span id="sidebarLevel">1</span></span>
                            <span id="nextLevelAmount">Next: $50K</span>
                        </div>
                    </div>
                </div>

                <div class="net-worth-breakdown">
                    <div class="breakdown-title">
                        <i class="fas fa-calculator"></i>
                        Net Worth Breakdown
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Cash Balance</span>
                        <span class="breakdown-value positive-value" id="cashBreakdown">$0</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Assets Value</span>
                        <span class="breakdown-value positive-value" id="assetsBreakdown">$0</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Stocks Value</span>
                        <span class="breakdown-value positive-value" id="stocksBreakdown">$0</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Business Value</span>
                        <span class="breakdown-value positive-value" id="businessBreakdown">$0</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Loan Debt</span>
                        <span class="breakdown-value negative-value" id="debtBreakdown">-$0</span>
                    </div>
                    <div class="breakdown-item" style="border-top: 2px solid var(--primary); padding-top: 12px; margin-top: 12px;">
                        <span class="breakdown-label"><strong>Total Net Worth</strong></span>
                        <span class="breakdown-value" id="totalNetWorth">$0</span>
                    </div>
                </div>

                <div class="detailed-stats">
                    <div class="stat-card">
                        <div class="stat-label">ROI</div>
                        <div class="stat-value" id="roiStat">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Assets</div>
                        <div class="stat-value" id="assetsCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Earnings</div>
                        <div class="stat-value" id="lifetimeEarnings">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Rank</div>
                        <div class="stat-value">#<span id="leaderboardRank">-</span></div>
                    </div>
                </div>

                <div class="badges" id="badgesContainer">
                    <span class="badge">New Investor</span>
                </div>

                <ul class="sidebar-menu">
                    <li><a href="#" class="active" data-section="dashboard"><i class="fas fa-home"></i><span>Dashboard</span></a></li>
                    <li><a href="#" data-section="marketplace"><i class="fas fa-store"></i><span>Marketplace</span></a></li>
                    <li><a href="#" data-section="portfolio"><i class="fas fa-chart-pie"></i><span>My Portfolio</span></a></li>
                    <li><a href="#" data-section="stocks"><i class="fas fa-chart-line"></i><span>Stock Market</span></a></li>
                    <li><a href="#" data-section="trading"><i class="fas fa-exchange-alt"></i><span>Trading Hub</span></a></li>
                    <li><a href="#" data-section="business"><i class="fas fa-building"></i><span>Business Empire</span></a></li>
                    <li><a href="#" data-section="quests"><i class="fas fa-trophy"></i><span>Quests & Rewards</span></a></li>
                    <li><a href="#" data-section="insurance"><i class="fas fa-shield-alt"></i><span>Insurance</span></a></li>
                    <li><a href="#" data-section="research"><i class="fas fa-flask"></i><span>Research Lab</span></a></li>
                    <li><a href="#" data-section="leaderboard"><i class="fas fa-crown"></i><span>Leaderboard</span></a></li>
                    <li><a href="#" data-section="loans"><i class="fas fa-hand-holding-usd"></i><span>Loan Center</span></a></li>
                    <li><a href="#" data-section="settings"><i class="fas fa-cog"></i><span>Settings</span></a></li>
                </ul>
            </aside>

            <main class="main-content">
                <!-- Dashboard Section -->
                <section id="dashboard-section" class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">Elite Dashboard</h2>
                        <div class="section-actions">
                            <button class="btn btn-outline" id="refreshDashboard">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <div class="dashboard-widgets">
                        <div class="widget">
                            <div class="widget-header">
                                <div class="widget-title">Net Worth Growth</div>
                                <div class="widget-growth positive">
                                    <i class="fas fa-arrow-up"></i> <span id="netWorthGrowth">0%</span>
                                </div>
                            </div>
                            <div class="widget-value" id="netWorthWidget">$0</div>
                            <div class="widget-meta" style="font-size: 12px; opacity: 0.7; margin-top: 8px;">
                                Level <span id="dashboardLevel">1</span> â€¢ Next level salary: $<span id="nextLevelSalary">400</span>
                            </div>
                            <div style="height: 120px; margin-top: 15px;">
                                <canvas id="netWorthChart"></canvas>
                            </div>
                        </div>

                        <div class="widget">
                            <div class="widget-header">
                                <div class="widget-title">Passive Income</div>
                                <div class="widget-growth positive">
                                    <i class="fas fa-arrow-up"></i> <span id="incomeGrowth">0%</span>
                                </div>
                            </div>
                            <div class="widget-value" id="passiveIncomeWidget">$0/30min</div>
                            <div class="widget-meta" style="font-size: 12px; opacity: 0.7; margin-top: 8px;">
                                From <span id="activeAssetsCount">0</span> active assets
                            </div>
                            <div style="height: 120px; margin-top: 15px;">
                                <canvas id="incomeChart"></canvas>
                            </div>
                        </div>

                        <div class="widget">
                            <div class="widget-header">
                                <div class="widget-title">Next Salary</div>
                                <div class="widget-growth" style="background: rgba(255, 193, 7, 0.1); color: var(--warning);">
                                    <i class="fas fa-dollar-sign"></i> $<span id="salaryAmount">100</span>
                                </div>
                            </div>
                            <div class="widget-value" id="nextSalaryWidget">00:35:00</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="salaryProgress"></div>
                            </div>
                            
                            <div class="widget-title" style="margin-top: 20px;">Next Reward</div>
                            <div class="widget-value" id="nextRewardWidget">00:30:00</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="rewardProgress"></div>
                            </div>
                        </div>

                        <div class="widget">
                            <div class="widget-header">
                                <div class="widget-title">Active Quests</div>
                                <div class="widget-growth positive">
                                    <i class="fas fa-tasks"></i> <span id="activeQuestsCount">3</span>
                                </div>
                            </div>
                            <div class="widget-value" id="questProgressWidget">67%</div>
                            <div style="margin-top: 15px;">
                                <div style="font-size: 12px; margin-bottom: 5px;">Daily Login Streak: <span id="loginStreak">1</span> days</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="streakProgress" style="width: 14%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section-header" style="margin-top: 40px;">
                        <h2 class="section-title">Portfolio Analytics</h2>
                    </div>
                    <div style="height: 350px;">
                        <canvas id="assetDistributionChart"></canvas>
                    </div>
                </section>

                <!-- Stock Market Section -->
                <section id="stocks-section" class="content-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">Stock Market</h2>
                        <div class="section-actions">
                            <button class="btn btn-primary" id="buyStockBtn">
                                <i class="fas fa-chart-line"></i> Buy Stocks
                            </button>
                            <button class="btn btn-outline" id="refreshStocks">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Stock Ticker -->
                    <div class="stock-ticker">
                        <div class="ticker-content" id="stockTicker">
                            <!-- Dynamic stock ticker will be populated here -->
                        </div>
                    </div>

                    <!-- Stock Chart -->
                    <div class="widget">
                        <div class="widget-header">
                            <div class="widget-title">Market Overview</div>
                            <select id="stockSelector" class="form-input" style="width: auto; padding: 8px;">
                                <option value="AAPL">Apple Inc.</option>
                                <option value="TSLA">Tesla Inc.</option>
                                <option value="GOOGL">Alphabet Inc.</option>
                                <option value="MSFT">Microsoft Corp.</option>
                                <option value="NVDA">NVIDIA Corp.</option>
                            </select>
                        </div>
                        <div class="stock-chart">
                            <canvas id="stockChart"></canvas>
                        </div>
                    </div>

                    <!-- Stock Portfolio -->
                    <div class="widget">
                        <div class="widget-header">
                            <div class="widget-title">Your Stock Portfolio</div>
                            <div class="widget-growth positive">
                                <i class="fas fa-chart-line"></i> <span id="stockPortfolioGrowth">+0%</span>
                            </div>
                        </div>
                        <div id="stockPortfolio">
                            <!-- Stock holdings will be displayed here -->
                        </div>
                    </div>
                </section>

                <!-- Trading Hub Section -->
                <section id="trading-section" class="content-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">Trading Hub</h2>
                        <div class="section-actions">
                            <button class="btn btn-primary" id="createTradeBtn">
                                <i class="fas fa-plus"></i> Create Trade
                            </button>
                            <button class="btn btn-success" id="myTradesBtn">
                                <i class="fas fa-exchange-alt"></i> My Trades
                            </button>
                        </div>
                    </div>

                    <div class="dashboard-widgets">
                        <div class="widget">
                            <div class="widget-header">
                                <div class="widget-title">Trading Stats</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 20px; font-weight: 700; color: var(--success);" id="successfulTrades">0</div>
                                    <div style="font-size: 12px; opacity: 0.7;">Successful Trades</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 20px; font-weight: 700; color: var(--primary);" id="totalTrades">0</div>
                                    <div style="font-size: 12px; opacity: 0.7;">Total Trades</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 20px; font-weight: 700; color: var(--warning);" id="tradingProfit">$0</div>
                                    <div style="font-size: 12px; opacity: 0.7;">Trading Profit</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 20px; font-weight: 700; color: var(--info);" id="tradingRank">-</div>
                                    <div style="font-size: 12px; opacity: 0.7;">Trading Rank</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="trade-grid" id="tradeGrid">
                        <!-- Active trades will be populated here -->
                    </div>
                </section>

                <!-- Business Empire Section -->
                <section id="business-section" class="content-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">Business Empire</h2>
                        <div class="section-actions">
                            <button class="btn btn-primary" id="createBusinessBtn">
                                <i class="fas fa-plus"></i> Start Business
                            </button>
                            <button class="btn btn-success" id="upgradeAllBtn">
                                <i class="fas fa-arrow-up"></i> Upgrade All
                            </button>
                        </div>
                    </div>

                    <div class="dashboard-widgets">
                        <div class="widget">
                            <div class="widget-header">
                                <div class="widget-title">Empire Overview</div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--primary);" id="totalBusinesses">0</div>
                                    <div style="font-size: 12px; opacity: 0.7;">Active Businesses</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="businessIncome">$0</div>
                                    <div style="font-size: 12px; opacity: 0.7;">Income/Hour</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--warning);" id="totalEmployees">0</div>
                                    <div style="font-size: 12px; opacity: 0.7;">Total Employees</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--info);" id="businessValue">$0</div>
                                    <div style="font-size: 12px; opacity: 0.7;">Total Value</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="business-grid" id="businessGrid">
                        <!-- Businesses will be populated here -->
                    </div>
                </section>

                <!-- Quests & Rewards Section -->
                <section id="quests-section" class="content-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">Quests & Achievements</h2>
                        <div class="section-actions">
                            <button class="btn btn-success" id="claimDailyBtn">
                                <i class="fas fa-gift"></i> Daily Bonus
                            </button>
                            <button class="btn btn-outline" id="refreshQuests">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Daily Login Bonus -->
                    <div class="widget" style="margin-bottom: 30px;">
                        <div class="widget-header">
                            <div class="widget-title">Daily Login Streak</div>
                            <div class="widget-growth positive">
                                <i class="fas fa-fire"></i> <span id="currentStreak">1</span> days
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-top: 15px;">
                            <div class="daily-reward" data-day="1">
                                <div class="reward-day">Day 1</div>
                                <div class="reward-amount">$100</div>
                            </div>
                            <div class="daily-reward" data-day="2">
                                <div class="reward-day">Day 2</div>
                                <div class="reward-amount">$200</div>
                            </div>
                            <div class="daily-reward" data-day="3">
                                <div class="reward-day">Day 3</div>
                                <div class="reward-amount">$500</div>
                            </div>
                            <div class="daily-reward" data-day="4">
                                <div class="reward-day">Day 4</div>
                                <div class="reward-amount">$1K</div>
                            </div>
                            <div class="daily-reward" data-day="5">
                                <div class="reward-day">Day 5</div>
                                <div class="reward-amount">$2K</div>
                            </div>
                            <div class="daily-reward" data-day="6">
                                <div class="reward-day">Day 6</div>
                                <div class="reward-amount">$5K</div>
                            </div>
                            <div class="daily-reward" data-day="7">
                                <div class="reward-day">Day 7</div>
                                <div class="reward-amount">$10K</div>
                            </div>
                        </div>
                    </div>

                    <!-- Active Quests -->
                    <div class="widget">
                        <div class="widget-header">
                            <div class="widget-title">Active Quests</div>
                        </div>
                        <div class="quest-list" id="questList">
                            <!-- Quests will be populated here -->
                        </div>
                    </div>
                </section>

                <!-- Insurance Section -->
                <section id="insurance-section" class="content-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">Insurance & Risk Management</h2>
                        <div class="section-actions">
                            <button class="btn btn-primary" id="buyInsuranceBtn">
                                <i class="fas fa-shield-alt"></i> Buy Insurance
                            </button>
                            <button class="btn btn-outline" id="riskAssessmentBtn">
                                <i class="fas fa-chart-bar"></i> Risk Assessment
                            </button>
                        </div>
                    </div>

                    <!-- Risk Overview -->
                    <div class="widget" style="margin-bottom: 30px;">
                        <div class="widget-header">
                            <div class="widget-title">Portfolio Risk Assessment</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 30px;">
                            <div class="risk-meter">
                                <div class="risk-value" id="riskScore">LOW</div>
                            </div>
                            <div style="flex: 1;">
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>Market Risk</span>
                                        <span id="marketRisk">25%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="marketRiskBar" style="width: 25%;"></div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>Liquidity Risk</span>
                                        <span id="liquidityRisk">15%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="liquidityRiskBar" style="width: 15%;"></div>
                                    </div>
                                </div>
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>Credit Risk</span>
                                        <span id="creditRisk">10%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="creditRiskBar" style="width: 10%;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Insurance Policies -->
                    <div class="insurance-grid" id="insuranceGrid">
                        <!-- Insurance options will be populated here -->
                    </div>
                </section>

                <!-- Marketplace Section -->
                <section id="marketplace-section" class="content-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">Asset Marketplace</h2>
                        <div class="section-actions">
                            <button class="btn btn-primary" id="loanBtn">
                                <i class="fas fa-hand-holding-usd"></i> Quick Loan
                            </button>
                            <button class="btn btn-outline" id="refreshMarket">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <div class="marketplace-filters" style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                        <select class="form-input" id="categoryFilter" style="min-width: 180px;">
                            <option value="all">All Categories</option>
                            <option value="real-estate">Real Estate</option>
                            <option value="tech">Technology</option>
                            <option value="energy">Energy</option>
                            <option value="commodities">Commodities</option>
                            <option value="infrastructure">Infrastructure</option>
                            <option value="vehicles">Vehicles</option>
                        </select>

                        <select class="form-input" id="sortFilter" style="min-width: 160px;">
                            <option value="roi-desc">Highest ROI</option>
                            <option value="roi-asc">Lowest ROI</option>
                            <option value="price-desc">Highest Price</option>
                            <option value="price-asc">Lowest Price</option>
                            <option value="reward-desc">Highest Reward</option>
                        </select>

                        <div style="flex-grow: 1;">
                            <input type="text" class="form-input" placeholder="Search assets..." id="assetSearch">
                        </div>
                    </div>

                    <div class="asset-grid" id="assetGrid">
                        <!-- Assets will be populated by JavaScript -->
                    </div>
                </section>

                <!-- Portfolio Section -->
                <section id="portfolio-section" class="content-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">Investment Portfolio</h2>
                        <div class="section-actions">
                            <button class="btn btn-success" id="collectAllBtn">
                                <i class="fas fa-coins"></i> Collect All
                            </button>
                            <button class="btn btn-danger" id="sellAllBtn">
                                <i class="fas fa-fire"></i> Liquidate All
                            </button>
                        </div>
                    </div>

                    <div id="assetsList">
                        <!-- Owned assets will be populated by JavaScript -->
                    </div>
                </section>

                <!-- Research Lab Section -->
                <section id="research-section" class="content-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">Research Laboratory</h2>
                        <div class="section-actions">
                            <button class="btn btn-outline" id="researchInfoBtn">
                                <i class="fas fa-info-circle"></i> How It Works
                            </button>
                        </div>
                    </div>

                    <div class="widget" style="margin-bottom: 35px;">
                        <div class="widget-header">
                            <div class="widget-title">Research Points</div>
                            <div class="widget-growth positive">
                                <i class="fas fa-plus-circle"></i> <span id="researchRate">1/10min</span>
                            </div>
                        </div>
                        <div class="widget-value" id="researchPoints">0</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="researchProgress"></div>
                        </div>
                        
                        <div class="widget-title" style="margin-top: 15px;">Next Point In</div>
                        <div class="widget-value" style="font-size: 20px;" id="nextResearchPoint">00:10:00</div>
                    </div>

                    <div class="asset-grid" id="researchAssets">
                        <!-- Research assets will be populated by JavaScript -->
                    </div>
                </section>

                <!-- Leaderboard Section -->
                <section id="leaderboard-section" class="content-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">Global Leaderboard</h2>
                        <div class="section-actions">
                            <button class="btn btn-outline" id="refreshLeaderboard">
                                <i class="fas fa-sync-alt"></i> Refresh Rankings
                            </button>
                        </div>
                    </div>
                    
                    <div class="leaderboard-container">
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Player</th>
                                    <th>Level</th>
                                    <th style="text-align: right;">Net Worth</th>
                                    <th style="text-align: right;">ROI</th>
                                    <th style="text-align: right;">Assets</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardTable">
                                <!-- Leaderboard will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Loan Center Section -->
                <section id="loans-section" class="content-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">Loan Center</h2>
                        <div class="section-actions">
                            <button class="btn btn-primary" id="newLoanBtn">
                                <i class="fas fa-plus"></i> New Loan
                            </button>
                        </div>
                    </div>

                    <div class="widget" style="margin-bottom: 30px;">
                        <div class="widget-header">
                            <div class="widget-title">Current Loan Status</div>
                        </div>
                        <div class="loan-status" id="loanStatus">
                            <div class="loan-info">
                                <div class="breakdown-item">
                                    <span>Outstanding Debt</span>
                                    <span class="negative-value">$<span id="currentDebt">0</span></span>
                                </div>
                                <div class="breakdown-item">
                                    <span>Interest Rate</span>
                                    <span><span id="currentInterest">0</span>% Annual</span>
                                </div>
                                <div class="breakdown-item">
                                    <span>Monthly Payment</span>
                                    <span class="negative-value">$<span id="monthlyPayment">0</span></span>
                                </div>
                            </div>
                            <div id="noLoanMessage" style="text-align: center; padding: 30px; opacity: 0.7;">
                                <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 15px; color: var(--success);"></i>
                                <p>No active loans. Your financial status is excellent!</p>
                            </div>
                        </div>
                    </div>

                    <div id="repaymentSection" style="display: none;">
                        <div class="widget">
                            <div class="widget-header">
                                <div class="widget-title">Loan Repayment</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Repayment Amount</label>
                                <input type="number" class="form-input" id="repaymentAmount" placeholder="Enter amount to repay">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0;">
                                <button class="btn btn-outline quick-amount-btn" data-percentage="25">25%</button>
                                <button class="btn btn-outline quick-amount-btn" data-percentage="50">50%</button>
                                <button class="btn btn-outline quick-amount-btn" data-percentage="75">75%</button>
                                <button class="btn btn-outline quick-amount-btn" data-percentage="100">Full</button>
                            </div>
                            
                            <button class="btn btn-success" id="repayLoanBtn" style="width: 100%;">
                                <i class="fas fa-credit-card"></i> Repay Loan
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Settings Section -->
                <section id="settings-section" class="content-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">Game Settings</h2>
                    </div>

                    <div class="widget" style="margin-bottom: 25px;">
                        <div class="widget-header">
                            <div class="widget-title">Player Profile</div>
                        </div>
                        <div style="padding: 20px;">
                            <div class="form-group">
                                <label class="form-label">Player Name</label>
                                <input type="text" id="playerNameInput" class="form-input" value="Elite Investor">
                            </div>
                            <button class="btn btn-primary" id="updateProfileBtn">
                                <i class="fas fa-save"></i> Update Profile
                            </button>
                        </div>
                    </div>

                    <div class="widget" style="margin-bottom: 25px;">
                        <div class="widget-header">
                            <div class="widget-title">Game Data Management</div>
                        </div>
                        <div style="padding: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                            <button class="btn btn-success" id="saveGameBtn">
                                <i class="fas fa-save"></i> Save Game
                            </button>
                            <button class="btn btn-outline" id="loadGameBtn">
                                <i class="fas fa-folder-open"></i> Load Game
                            </button>
                            <button class="btn btn-danger" id="resetGameBtn">
                                <i class="fas fa-trash"></i> Reset Game
                            </button>
                        </div>
                    </div>

                    <div class="widget">
                        <div class="widget-header">
                            <div class="widget-title">Notification Preferences</div>
                        </div>
                        <div style="padding: 20px;">
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="rewardNotifications" checked style="transform: scale(1.2);">
                                    <span>Reward Notifications</span>
                                </label>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="salaryNotifications" checked style="transform: scale(1.2);">
                                    <span>Salary Notifications</span>
                                </label>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="marketEventNotifications" checked style="transform: scale(1.2);">
                                    <span>Market Event Notifications</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Enhanced Notification Toast -->
    <div class="notification-toast" id="notificationToast">
        <div class="notification-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="notification-content">
            <h4 id="notificationTitle">Notification</h4>
            <p id="notificationMessage">This is a notification message</p>
        </div>
        <div style="margin-left: 15px; cursor: pointer; opacity: 0.7;" id="closeNotification">
            <i class="fas fa-times"></i>
        </div>
    </div>
    
    <!-- All Modals -->
    <!-- Asset Details Modal -->
    <div class="modal" id="assetModal">
        <div class="modal-content">
            <span class="close-modal" id="closeModal">&times;</span>
            <div style="text-align: center; font-size: 60px; margin-bottom: 20px;" id="modalAssetIcon"></div>
            <div class="modal-header">
                <h3 id="modalAssetName"></h3>
                <div class="asset-category" id="modalAssetCategory"></div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 25px 0;">
                <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px;" id="modalAssetPrice"></div>
                    <div style="font-size: 12px; opacity: 0.7;">Current Price</div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px;" id="modalAssetReward"></div>
                    <div style="font-size: 12px; opacity: 0.7;">Reward / 30min</div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px;" id="modalAssetROI"></div>
                    <div style="font-size: 12px; opacity: 0.7;">ROI</div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px;" id="modalAssetGrowth"></div>
                    <div style="font-size: 12px; opacity: 0.7;">Growth / hour</div>
                </div>
            </div>
            
            <p id="modalAssetDescription" style="margin: 20px 0; line-height: 1.6; opacity: 0.9;"></p>
            
            <div style="display: flex; gap: 15px; margin-top: 25px;" id="modalAssetActions">
                <!-- Buy/Sell buttons will be added here -->
            </div>
        </div>
    </div>
    
    <!-- Loan Modal -->
    <div class="modal" id="loanModal">
        <div class="modal-content">
            <span class="close-modal" id="closeLoanModal">&times;</span>
            <div class="modal-header">
                <h3>Business Loan Application</h3>
                <p>Accelerate your investment growth with strategic financing</p>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 25px 0;">
                <div class="loan-option" data-amount="10000" data-interest="10">
                    <div style="font-weight: 600; margin-bottom: 8px;">Starter Loan</div>
                    <div style="font-size: 20px; font-weight: 700; margin: 10px 0;">$10,000</div>
                    <div style="color: var(--danger); font-size: 14px;">10% Annual Interest</div>
                </div>
                <div class="loan-option" data-amount="25000" data-interest="15">
                    <div style="font-weight: 600; margin-bottom: 8px;">Growth Loan</div>
                    <div style="font-size: 20px; font-weight: 700; margin: 10px 0;">$25,000</div>
                    <div style="color: var(--danger); font-size: 14px;">15% Annual Interest</div>
                </div>
                <div class="loan-option" data-amount="50000" data-interest="20">
                    <div style="font-weight: 600; margin-bottom: 8px;">Expansion Loan</div>
                    <div style="font-size: 20px; font-weight: 700; margin: 10px 0;">$50,000</div>
                    <div style="color: var(--danger); font-size: 14px;">20% Annual Interest</div>
                </div>
                <div class="loan-option" data-amount="100000" data-interest="25">
                    <div style="font-weight: 600; margin-bottom: 8px;">Elite Loan</div>
                    <div style="font-size: 20px; font-weight: 700; margin: 10px 0;">$100,000</div>
                    <div style="color: var(--danger); font-size: 14px;">25% Annual Interest</div>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button class="btn btn-outline" id="cancelLoanBtn" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" id="confirmLoanBtn" disabled style="flex: 1;">Approve Loan</button>
            </div>
        </div>
    </div>

    <!-- Trading Modal -->
    <div class="modal" id="tradingModal">
        <div class="modal-content">
            <span class="close-modal" id="closeTradingModal">&times;</span>
            <div class="modal-header">
                <h3>Create Trade Offer</h3>
                <p>List your assets for trading with other players</p>
            </div>
            
            <div class="form-group">
                <label class="form-label">Select Asset to Trade</label>
                <select class="form-input" id="tradeAssetSelect">
                    <option value="">Select an asset...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Asking Price</label>
                <input type="number" class="form-input" id="tradePrice" placeholder="Enter asking price">
            </div>
            
            <div class="form-group">
                <label class="form-label">Trade Description</label>
                <textarea class="form-input" id="tradeDescription" rows="3" placeholder="Describe your trade offer..."></textarea>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button class="btn btn-outline" id="cancelTradeBtn" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" id="confirmTradeBtn" style="flex: 1;">Create Trade</button>
            </div>
        </div>
    </div>

    <!-- Business Creation Modal -->
    <div class="modal" id="businessModal">
        <div class="modal-content">
            <span class="close-modal" id="closeBusinessModal">&times;</span>
            <div class="modal-header">
                <h3>Start New Business</h3>
                <p>Launch your business empire and generate passive income</p>
            </div>
            
            <div style="display: grid; gap: 15px; margin: 25px 0;" id="businessTypes">
                <!-- Business types will be populated here -->
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button class="btn btn-outline" id="cancelBusinessBtn" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" id="confirmBusinessBtn" disabled style="flex: 1;">Start Business</button>
            </div>
        </div>
    </div>

    <!-- Stock Purchase Modal -->
    <div class="modal" id="stockModal">
        <div class="modal-content">
            <span class="close-modal" id="closeStockModal">&times;</span>
            <div class="modal-header">
                <h3>Buy Stocks</h3>
                <p>Invest in the stock market for potential returns</p>
            </div>
            
            <div class="form-group">
                <label class="form-label">Stock Symbol</label>
                <select class="form-input" id="stockSymbolSelect">
                    <option value="AAPL">AAPL - Apple Inc.</option>
                    <option value="TSLA">TSLA - Tesla Inc.</option>
                    <option value="GOOGL">GOOGL - Alphabet Inc.</option>
                    <option value="MSFT">MSFT - Microsoft Corp.</option>
                    <option value="NVDA">NVDA - NVIDIA Corp.</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Number of Shares</label>
                <input type="number" class="form-input" id="shareQuantity" placeholder="Enter number of shares" min="1">
            </div>
            
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; margin: 20px 0;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Current Price:</span>
                    <span id="currentStockPrice">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Total Cost:</span>
                    <span id="totalStockCost">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-weight: 700;">
                    <span>Commission (2%):</span>
                    <span id="stockCommission">$0.00</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button class="btn btn-outline" id="cancelStockBtn" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" id="confirmStockBtn" style="flex: 1;">Buy Stocks</button>
            </div>
        </div>
    </div>

    <!-- Insurance Modal -->
    <div class="modal" id="insuranceModal">
        <div class="modal-content">
            <span class="close-modal" id="closeInsuranceModal">&times;</span>
            <div class="modal-header">
                <h3>Insurance Policies</h3>
                <p>Protect your investments from market volatility and disasters</p>
            </div>
            
            <div style="display: grid; gap: 15px; margin: 25px 0;" id="insurancePolicies">
                <!-- Insurance policies will be populated here -->
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button class="btn btn-outline" id="cancelInsuranceBtn" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" id="confirmInsuranceBtn" disabled style="flex: 1;">Purchase Policy</button>
            </div>
        </div>
    </div>

    <!-- Research Info Modal -->
    <div class="modal" id="researchInfoModal">
        <div class="modal-content">
            <span class="close-modal" id="closeResearchInfoModal">&times;</span>
            <div class="modal-header">
                <h3>Research Laboratory Guide</h3>
            </div>
            <div style="text-align: left; line-height: 1.6;">
                <h4 style="margin-bottom: 15px; color: var(--secondary);">How Research Works:</h4>
                <ul style="margin-left: 20px; margin-bottom: 25px;">
                    <li style="margin-bottom: 8px;">Generate research points automatically every 10 minutes</li>
                    <li style="margin-bottom: 8px;">Invest 5 points to unlock premium assets</li>
                    <li style="margin-bottom: 8px;">Research Expert badge doubles point generation rate</li>
                    <li style="margin-bottom: 8px;">Unlocked assets become available in the marketplace</li>
                </ul>
                
                <h4 style="margin-bottom: 15px; color: var(--secondary);">Premium Asset Benefits:</h4>
                <ul style="margin-left: 20px;">
                    <li style="margin-bottom: 8px;">Higher ROI investments with superior returns</li>
                    <li style="margin-bottom: 8px;">Exclusive real estate in prime locations</li>
                    <li style="margin-bottom: 8px;">Cutting-edge technology startups</li>
                    <li style="margin-bottom: 8px;">Strategic infrastructure projects</li>
                </ul>
            </div>
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button class="btn btn-primary" id="closeResearchInfoBtn" style="flex: 1;">Got It!</button>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Enhanced Game Data Structure with NEW FEATURES
        const gameData = {
            player: {
                id: "user_" + Math.random().toString(36).substr(2, 9),
                name: "Elite Investor",
                cash: 5000,
                salaryTimer: 30 * 60, // 30 minutes in seconds
                rewardTimer: 30 * 60, // 30 minutes in seconds
                netWorth: 5000,
                level: 1,
                salaryCount: 0, // Track number of salaries collected
                assets: [],
                // NEW: Stock portfolio
                stocks: {},
                // NEW: Business empire
                businesses: [],
                // NEW: Trading stats
                tradingStats: {
                    totalTrades: 0,
                    successfulTrades: 0,
                    tradingProfit: 0,
                    reputation: 100
                },
                // NEW: Quest progress
                quests: {
                    daily: {
                        loginStreak: 1,
                        lastLogin: Date.now(),
                        bonusClaimed: false
                    },
                    active: []
                },
                // NEW: Insurance policies
                insurance: [],
                stats: {
                    lifetimeEarnings: 0,
                    totalInvested: 0,
                    totalWithdrawn: 0,
                    bestPerformingAsset: null,
                    worstPerformingAsset: null,
                    roi: 0,
                    researchPoints: 0,
                    researchTimer: 10 * 60, // Changed to 10 minutes
                    badges: ["New Investor"],
                    loanDebt: 0,
                    loanInterest: 0,
                    loanRepaymentHistory: []
                },
                settings: {
                    rewardNotifications: true,
                    salaryNotifications: true,
                    marketEventNotifications: true
                },
                lastUpdate: Date.now(),
                netWorthHistory: [5000, 5000, 5000, 5000, 5000, 5000, 5000]
            },
            levels: [
                { level: 1, requirement: 0, salary: 100, name: "Novice Investor" },
                { level: 2, requirement: 50000, salary: 400, name: "Junior Trader" },
                { level: 3, requirement: 100000, salary: 800, name: "Asset Manager" },
                { level: 4, requirement: 250000, salary: 1600, name: "Investment Advisor" },
                { level: 5, requirement: 500000, salary: 3200, name: "Portfolio Manager" },
                { level: 6, requirement: 1000000, salary: 6400, name: "Wealth Manager" },
                { level: 7, requirement: 2500000, salary: 12800, name: "Investment Banker" },
                { level: 8, requirement: 5000000, salary: 25600, name: "Fund Manager" },
                { level: 9, requirement: 10000000, salary: 51200, name: "Financial Mogul" },
                { level: 10, requirement: 25000000, salary: 102400, name: "Elite Investor" }
            ],
            // NEW: Stock market data
            stockMarket: {
                stocks: {
                    AAPL: { name: "Apple Inc.", price: 175.50, history: [], volatility: 0.02 },
                    TSLA: { name: "Tesla Inc.", price: 220.30, history: [], volatility: 0.05 },
                    GOOGL: { name: "Alphabet Inc.", price: 2750.80, history: [], volatility: 0.03 },
                    MSFT: { name: "Microsoft Corp.", price: 330.25, history: [], volatility: 0.025 },
                    NVDA: { name: "NVIDIA Corp.", price: 450.75, history: [], volatility: 0.04 }
                }
            },
            // NEW: Trading marketplace
            tradingHub: {
                activeTrades: [],
                completedTrades: []
            },
            // NEW: Business types
            businessTypes: [
                {
                    id: "restaurant",
                    name: "Restaurant Chain",
                    icon: "ðŸ•",
                    basePrice: 25000,
                    baseIncome: 50,
                    description: "Food service business with steady customer flow",
                    maxLevel: 10
                },
                {
                    id: "tech",
                    name: "Tech Startup",
                    icon: "ðŸ’»",
                    basePrice: 50000,
                    baseIncome: 120,
                    description: "Technology company with high growth potential",
                    maxLevel: 8
                },
                {
                    id: "retail",
                    name: "Retail Store",
                    icon: "ðŸ›ï¸",
                    basePrice: 15000,
                    baseIncome: 30,
                    description: "Retail business with consistent revenue",
                    maxLevel: 12
                },
                {
                    id: "factory",
                    name: "Manufacturing",
                    icon: "ðŸ­",
                    basePrice: 100000,
                    baseIncome: 250,
                    description: "Industrial manufacturing facility",
                    maxLevel: 6
                },
                {
                    id: "bank",
                    name: "Local Bank",
                    icon: "ðŸ¦",
                    basePrice: 200000,
                    baseIncome: 500,
                    description: "Financial institution with premium returns",
                    maxLevel: 5
                }
            ],
            // NEW: Quest system
            questTemplates: [
                {
                    id: "earn_money",
                    name: "Wealth Builder",
                    description: "Earn $10,000 in total income",
                    target: 10000,
                    reward: 2000,
                    type: "cumulative"
                },
                {
                    id: "buy_assets",
                    name: "Asset Collector",
                    description: "Purchase 5 different assets",
                    target: 5,
                    reward: 5000,
                    type: "count"
                },
                {
                    id: "level_up",
                    name: "Level Master",
                    description: "Reach Level 3",
                    target: 3,
                    reward: 10000,
                    type: "level"
                },
                {
                    id: "research_points",
                    name: "Research Expert",
                    description: "Accumulate 20 research points",
                    target: 20,
                    reward: 3000,
                    type: "research"
                },
                {
                    id: "net_worth",
                    name: "Millionaire",
                    description: "Achieve $1,000,000 net worth",
                    target: 1000000,
                    reward: 50000,
                    type: "networth"
                }
            ],
            // NEW: Insurance options
            insuranceTypes: [
                {
                    id: "basic",
                    name: "Basic Protection",
                    coverage: 0.5,
                    cost: 1000,
                    duration: 30 * 24 * 60 * 60, // 30 days in seconds
                    description: "Covers 50% of losses from market crashes"
                },
                {
                    id: "premium",
                    name: "Premium Shield",
                    coverage: 0.75,
                    cost: 2500,
                    duration: 30 * 24 * 60 * 60,
                    description: "Covers 75% of losses from market events"
                },
                {
                    id: "elite",
                    name: "Elite Guarantee",
                    coverage: 0.9,
                    cost: 5000,
                    duration: 30 * 24 * 60 * 60,
                    description: "Covers 90% of all investment losses"
                }
            ],
            market: {
                inflationRate: 1.0,
                activeEvent: null,
                eventTimer: 0,
                assets: [
                    // Real Estate
                    {
                        id: "RE001",
                        name: "Downtown Loft",
                        category: "real-estate",
                        price: 75000,
                        basePrice: 75000,
                        reward: 110,
                        appreciationRate: 0.017 / 60 / 60, // 1.7% per hour converted to per second
                        owned: false,
                        unlocked: true,
                        image: "ðŸ¢",
                        description: "A modern apartment in the city center with high rental demand and steady appreciation."
                    },
                    {
                        id: "RE002",
                        name: "Beach Villa",
                        category: "real-estate",
                        price: 120000,
                        basePrice: 120000,
                        reward: 150,
                        appreciationRate: 0.02 / 60 / 60,
                        owned: false,
                        unlocked: true,
                        image: "ðŸ¡",
                        description: "Luxury beachfront property with high appreciation potential and premium rental income."
                    },
                    {
                        id: "RE003",
                        name: "Commercial Plaza",
                        category: "real-estate",
                        price: 250000,
                        basePrice: 250000,
                        reward: 350,
                        appreciationRate: 0.022 / 60 / 60,
                        owned: false,
                        unlocked: false,
                        image: "ðŸ¬",
                        description: "Commercial property with multiple tenants providing stable income and long-term growth."
                    },
                    {
                        id: "RE004",
                        name: "Mountain Cabin",
                        category: "real-estate",
                        price: 85000,
                        basePrice: 85000,
                        reward: 95,
                        appreciationRate: 0.015 / 60 / 60,
                        owned: false,
                        unlocked: true,
                        image: "ðŸ”ï¸",
                        description: "Rustic cabin in a scenic mountain area with seasonal rental opportunities."
                    },
                    {
                        id: "RE005",
                        name: "Luxury Penthouse",
                        category: "real-estate",
                        price: 500000,
                        basePrice: 500000,
                        reward: 720,
                        appreciationRate: 0.025 / 60 / 60,
                        owned: false,
                        unlocked: false,
                        image: "ðŸ™ï¸",
                        description: "Ultra-luxury penthouse in the most prestigious area with exceptional rental yields."
                    },

                    // Technology
                    {
                        id: "TECH001",
                        name: "AI Startup",
                        category: "tech",
                        price: 50000,
                        basePrice: 50000,
                        reward: 85,
                        appreciationRate: 0.025 / 60 / 60,
                        volatility: 0.3,
                        owned: false,
                        unlocked: true,
                        image: "ðŸ¤–",
                        description: "Cutting-edge artificial intelligence company with high growth potential but market volatility."
                    },
                    {
                        id: "TECH002",
                        name: "Cloud Service",
                        category: "tech",
                        price: 90000,
                        basePrice: 90000,
                        reward: 130,
                        appreciationRate: 0.028 / 60 / 60,
                        volatility: 0.25,
                        owned: false,
                        unlocked: true,
                        image: "â˜ï¸",
                        description: "Cloud computing platform with recurring revenue and expanding market share."
                    },
                    {
                        id: "TECH003",
                        name: "VR Platform",
                        category: "tech",
                        price: 110000,
                        basePrice: 110000,
                        reward: 145,
                        appreciationRate: 0.03 / 60 / 60,
                        volatility: 0.35,
                        owned: false,
                        unlocked: false,
                        image: "ðŸ‘“",
                        description: "Virtual reality platform with innovative technology and growing user base."
                    },
                    {
                        id: "TECH004",
                        name: "Blockchain Network",
                        category: "tech",
                        price: 80000,
                        basePrice: 80000,
                        reward: 120,
                        appreciationRate: 0.035 / 60 / 60,
                        volatility: 0.4,
                        owned: false,
                        unlocked: false,
                        image: "â›“ï¸",
                        description: "Decentralized blockchain infrastructure with revolutionary potential but high volatility."
                    },
                    {
                        id: "TECH005",
                        name: "Quantum Computing",
                        category: "tech",
                        price: 300000,
                        basePrice: 300000,
                        reward: 480,
                        appreciationRate: 0.04 / 60 / 60,
                        volatility: 0.5,
                        owned: false,
                        unlocked: false,
                        image: "âš›ï¸",
                        description: "Next-generation quantum computing technology with massive future potential."
                    },

                    // Energy
                    {
                        id: "NRG001",
                        name: "Solar Farm",
                        category: "energy",
                        price: 80000,
                        basePrice: 80000,
                        reward: 95,
                        appreciationRate: 0.015 / 60 / 60,
                        owned: false,
                        unlocked: true,
                        image: "â˜€ï¸",
                        description: "Large-scale solar energy production facility with government subsidies and steady returns."
                    },
                    {
                        id: "NRG002",
                        name: "Wind Turbines",
                        category: "energy",
                        price: 65000,
                        basePrice: 65000,
                        reward: 75,
                        appreciationRate: 0.014 / 60 / 60,
                        owned: false,
                        unlocked: true,
                        image: "ðŸŒ¬ï¸",
                        description: "Wind energy installation providing clean power and consistent income."
                    },
                    {
                        id: "NRG003",
                        name: "Hydroelectric Plant",
                        category: "energy",
                        price: 180000,
                        basePrice: 180000,
                        reward: 220,
                        appreciationRate: 0.018 / 60 / 60,
                        owned: false,
                        unlocked: false,
                        image: "ðŸ’§",
                        description: "Hydroelectric power generation with long-term contracts and low operational costs."
                    },
                    {
                        id: "NRG004",
                        name: "Geothermal Plant",
                        category: "energy",
                        price: 150000,
                        basePrice: 150000,
                        reward: 185,
                        appreciationRate: 0.016 / 60 / 60,
                        owned: false,
                        unlocked: false,
                        image: "ðŸŒ‹",
                        description: "Underground thermal energy extraction with minimal environmental impact."
                    },
                    {
                        id: "NRG005",
                        name: "Nuclear Reactor",
                        category: "energy",
                        price: 800000,
                        basePrice: 800000,
                        reward: 1200,
                        appreciationRate: 0.022 / 60 / 60,
                        owned: false,
                        unlocked: false,
                        image: "â˜¢ï¸",
                        description: "Advanced nuclear power generation with massive energy output and long-term reliability."
                    },

                    // Commodities
                    {
                        id: "COM001",
                        name: "Gold Reserve",
                        category: "commodities",
                        price: 70000,
                        basePrice: 70000,
                        reward: 80,
                        appreciationRate: 0.012 / 60 / 60,
                        owned: false,
                        unlocked: true,
                        image: "ðŸ’°",
                        description: "Physical gold reserves providing a hedge against inflation and market volatility."
                    },
                    {
                        id: "COM002",
                        name: "Oil Field",
                        category: "commodities",
                        price: 110000,
                        basePrice: 110000,
                        reward: 120,
                        appreciationRate: 0.018 / 60 / 60,
                        owned: false,
                        unlocked: true,
                        image: "ðŸ›¢ï¸",
                        description: "Oil production field with fluctuating prices but high profit potential."
                    },
                    {
                        id: "COM003",
                        name: "Platinum Mine",
                        category: "commodities",
                        price: 95000,
                        basePrice: 95000,
                        reward: 105,
                        appreciationRate: 0.016 / 60 / 60,
                        owned: false,
                        unlocked: false,
                        image: "â›ï¸",
                        description: "Precious metals mine with strategic importance in technology manufacturing."
                    },
                    {
                        id: "COM004",
                        name: "Lithium Reserve",
                        category: "commodities",
                        price: 85000,
                        basePrice: 85000,
                        reward: 100,
                        appreciationRate: 0.02 / 60 / 60,
                        owned: false,
                        unlocked: false,
                        image: "ðŸ”‹",
                        description: "Critical battery material with growing demand from electric vehicle industry."
                    },
                    {
                        id: "COM005",
                        name: "Rare Earth Metals",
                        category: "commodities",
                        price: 200000,
                        basePrice: 200000,
                        reward: 280,
                        appreciationRate: 0.025 / 60 / 60,
                        owned: false,
                        unlocked: false,
                        image: "ðŸ’Ž",
                        description: "Extremely rare minerals essential for advanced technology manufacturing."
                    },

                    // Infrastructure
                    {
                        id: "INF001",
                        name: "Toll Bridge",
                        category: "infrastructure",
                        price: 150000,
                        basePrice: 150000,
                        reward: 180,
                        appreciationRate: 0.016 / 60 / 60,
                        owned: false,
                        unlocked: false,
                        image: "ðŸŒ‰",
                        description: "Essential transportation infrastructure with guaranteed income through toll collection."
                    },
                    {
                        id: "INF002",
                        name: "Cargo Port",
                        category: "infrastructure",
                        price: 300000,
                        basePrice: 300000,
                        reward: 350,
                        appreciationRate: 0.02 / 60 / 60,
                        owned: false,
                        unlocked: false,
                        image: "ðŸš¢",
                        description: "International shipping port with long-term contracts and strategic value."
                    },
                    {
                        id: "INF003",
                        name: "Fiber Network",
                        category: "infrastructure",
                        price: 200000,
                        basePrice: 200000,
                        reward: 240,
                        appreciationRate: 0.018 / 60 / 60,
                        owned: false,
                        unlocked: false,
                        image: "ðŸŒ",
                        description: "High-speed internet infrastructure serving major metropolitan areas."
                    },
                    {
                        id: "INF004",
                        name: "Space Station",
                        category: "infrastructure",
                        price: 1000000,
                        basePrice: 1000000,
                        reward: 1500,
                        appreciationRate: 0.03 / 60 / 60,
                        owned: false,
                        unlocked: false,
                        image: "ðŸ›°ï¸",
                        description: "Advanced orbital infrastructure for space-based research and commercial activities."
                    },

                    // Vehicles
                    {
                        id: "VEH001",
                        name: "Luxury Yacht",
                        category: "vehicles",
                        price: 125000,
                        basePrice: 125000,
                        reward: 140,
                        appreciationRate: 0.01 / 60 / 60,
                        owned: false,
                        unlocked: true,
                        image: "ðŸ›¥ï¸",
                        description: "Premium yacht available for charter with high rental fees but significant maintenance costs."
                    },
                    {
                        id: "VEH002",
                        name: "Fleet of EVs",
                        category: "vehicles",
                        price: 90000,
                        basePrice: 90000,
                        reward: 100,
                        appreciationRate: 0.015 / 60 / 60,
                        owned: false,
                        unlocked: true,
                        image: "ðŸš—",
                        description: "Electric vehicle fleet for ride-sharing services with growing market demand."
                    },
                    {
                        id: "VEH003",
                        name: "Private Jet",
                        category: "vehicles",
                        price: 200000,
                        basePrice: 200000,
                        reward: 220,
                        appreciationRate: 0.012 / 60 / 60,
                        owned: false,
                        unlocked: false,
                        image: "âœˆï¸",
                        description: "Luxury private aircraft for charter services to high-net-worth individuals."
                    },
                    {
                        id: "VEH004",
                        name: "Submarine Fleet",
                        category: "vehicles",
                        price: 750000,
                        basePrice: 750000,
                        reward: 900,
                        appreciationRate: 0.018 / 60 / 60,
                        owned: false,
                        unlocked: false,
                        image: "ðŸš¢",
                        description: "Specialized underwater vehicles for deep-sea exploration and research missions."
                    }
                ],
                events: [
                    {
                        name: "Market Boom",
                        effect: 1.15, // 15% price increase
                        duration: 300, // 5 minutes
                        probability: 0.1,
                        description: "Positive market sentiment is driving asset prices up across the board."
                    },
                    {
                        name: "Market Crash",
                        effect: 0.85, // 15% price decrease
                        duration: 300,
                        probability: 0.1,
                        description: "Market panic is causing a sell-off, reducing asset values temporarily."
                    },
                    {
                        name: "Tech Rally",
                        effect: 1.25, // 25% increase for tech
                        duration: 180,
                        probability: 0.05,
                        category: "tech",
                        description: "Breakthrough innovations are driving increased valuations in technology assets."
                    },
                    {
                        name: "Real Estate Surge",
                        effect: 1.20, // 20% increase for real estate
                        duration: 240,
                        probability: 0.04,
                        category: "real-estate",
                        description: "Housing shortage is causing real estate prices to surge rapidly."
                    },
                    {
                        name: "Commodity Slump",
                        effect: 0.80, // 20% decrease for commodities
                        duration: 300,
                        probability: 0.07,
                        category: "commodities",
                        description: "Oversupply in the commodities market is driving prices down."
                    },
                    {
                        name: "Energy Crisis",
                        effect: 1.30, // 30% increase for energy
                        duration: 360,
                        probability: 0.03,
                        category: "energy",
                        description: "Global energy shortages are driving renewable energy investments."
                    },
                    {
                        name: "Infrastructure Bill",
                        effect: 1.18, // 18% increase for infrastructure
                        duration: 450,
                        probability: 0.02,
                        category: "infrastructure",
                        description: "Government infrastructure spending is boosting related asset values."
                    },
                    {
                        name: "Vehicle Revolution",
                        effect: 1.22, // 22% increase for vehicles
                        duration: 280,
                        probability: 0.03,
                        category: "vehicles",
                        description: "Autonomous vehicle breakthroughs are revolutionizing transportation investments."
                    }
                ]
            },
            leaderboard: [
                // Will be populated with generated players
            ]
        };

        // Enhanced DOM Elements with new features
        const elements = {
            walletAmount: document.getElementById('walletAmount'),
            netWorth: document.getElementById('netWorth'),
            roiStat: document.getElementById('roiStat'),
            assetsCount: document.getElementById('assetsCount'),
            lifetimeEarnings: document.getElementById('lifetimeEarnings'),
            leaderboardRank: document.getElementById('leaderboardRank'),
            badgesContainer: document.getElementById('badgesContainer'),
            playerName: document.getElementById('playerName'),

            // Level system elements
            currentLevel: document.getElementById('currentLevel'),
            sidebarLevel: document.getElementById('sidebarLevel'),
            dashboardLevel: document.getElementById('dashboardLevel'),
            nextLevelSalary: document.getElementById('nextLevelSalary'),
            nextLevelAmount: document.getElementById('nextLevelAmount'),
            levelProgressFill: document.getElementById('levelProgressFill'),

            // Enhanced dashboard widgets
            netWorthWidget: document.getElementById('netWorthWidget'),
            netWorthGrowth: document.getElementById('netWorthGrowth'),
            passiveIncomeWidget: document.getElementById('passiveIncomeWidget'),
            incomeGrowth: document.getElementById('incomeGrowth'),
            nextSalaryWidget: document.getElementById('nextSalaryWidget'),
            nextRewardWidget: document.getElementById('nextRewardWidget'),
            salaryProgress: document.getElementById('salaryProgress'),
            rewardProgress: document.getElementById('rewardProgress'),
            salaryAmount: document.getElementById('salaryAmount'),
            activeAssetsCount: document.getElementById('activeAssetsCount'),

            // Net worth breakdown
            cashBreakdown: document.getElementById('cashBreakdown'),
            assetsBreakdown: document.getElementById('assetsBreakdown'),
            stocksBreakdown: document.getElementById('stocksBreakdown'),
            businessBreakdown: document.getElementById('businessBreakdown'),
            debtBreakdown: document.getElementById('debtBreakdown'),
            totalNetWorth: document.getElementById('totalNetWorth'),

            // Quest elements
            activeQuestsCount: document.getElementById('activeQuestsCount'),
            questProgressWidget: document.getElementById('questProgressWidget'),
            loginStreak: document.getElementById('loginStreak'),
            streakProgress: document.getElementById('streakProgress'),
            currentStreak: document.getElementById('currentStreak'),
            claimDailyBtn: document.getElementById('claimDailyBtn'),
            questList: document.getElementById('questList'),

            // Stock market elements
            stockTicker: document.getElementById('stockTicker'),
            stockChart: document.getElementById('stockChart'),
            stockSelector: document.getElementById('stockSelector'),
            stockPortfolio: document.getElementById('stockPortfolio'),
            stockPortfolioGrowth: document.getElementById('stockPortfolioGrowth'),
            buyStockBtn: document.getElementById('buyStockBtn'),
            refreshStocks: document.getElementById('refreshStocks'),

            // Trading elements
            tradeGrid: document.getElementById('tradeGrid'),
            createTradeBtn: document.getElementById('createTradeBtn'),
            myTradesBtn: document.getElementById('myTradesBtn'),
            successfulTrades: document.getElementById('successfulTrades'),
            totalTrades: document.getElementById('totalTrades'),
            tradingProfit: document.getElementById('tradingProfit'),
            tradingRank: document.getElementById('tradingRank'),

            // Business elements
            businessGrid: document.getElementById('businessGrid'),
            createBusinessBtn: document.getElementById('createBusinessBtn'),
            upgradeAllBtn: document.getElementById('upgradeAllBtn'),
            totalBusinesses: document.getElementById('totalBusinesses'),
            businessIncome: document.getElementById('businessIncome'),
            totalEmployees: document.getElementById('totalEmployees'),
            businessValue: document.getElementById('businessValue'),

            // Insurance elements
            insuranceGrid: document.getElementById('insuranceGrid'),
            buyInsuranceBtn: document.getElementById('buyInsuranceBtn'),
            riskAssessmentBtn: document.getElementById('riskAssessmentBtn'),
            riskScore: document.getElementById('riskScore'),
            marketRisk: document.getElementById('marketRisk'),
            liquidityRisk: document.getElementById('liquidityRisk'),
            creditRisk: document.getElementById('creditRisk'),
            marketRiskBar: document.getElementById('marketRiskBar'),
            liquidityRiskBar: document.getElementById('liquidityRiskBar'),
            creditRiskBar: document.getElementById('creditRiskBar'),

            // Loan debt indicator
            loanDebtIndicator: document.getElementById('loanDebtIndicator'),
            debtAmount: document.getElementById('debtAmount'),

            // Market event banner
            marketEventBanner: document.getElementById('marketEventBanner'),
            marketEventTitle: document.getElementById('marketEventTitle'),
            marketEventDescription: document.getElementById('marketEventDescription'),
            marketEventTimer: document.getElementById('marketEventTimer'),

            // Marketplace
            assetGrid: document.getElementById('assetGrid'),
            categoryFilter: document.getElementById('categoryFilter'),
            sortFilter: document.getElementById('sortFilter'),
            assetSearch: document.getElementById('assetSearch'),
            loanBtn: document.getElementById('loanBtn'),
            refreshMarket: document.getElementById('refreshMarket'),

            // Portfolio
            assetsList: document.getElementById('assetsList'),
            sellAllBtn: document.getElementById('sellAllBtn'),
            collectAllBtn: document.getElementById('collectAllBtn'),

            // Research
            researchPoints: document.getElementById('researchPoints'),
            nextResearchPoint: document.getElementById('nextResearchPoint'),
            researchAssets: document.getElementById('researchAssets'),
            researchProgress: document.getElementById('researchProgress'),
            researchRate: document.getElementById('researchRate'),
            researchInfoBtn: document.getElementById('researchInfoBtn'),

            // Leaderboard
            leaderboardTable: document.getElementById('leaderboardTable'),
            refreshLeaderboard: document.getElementById('refreshLeaderboard'),

            // Loan Center
            loanStatus: document.getElementById('loanStatus'),
            currentDebt: document.getElementById('currentDebt'),
            currentInterest: document.getElementById('currentInterest'),
            monthlyPayment: document.getElementById('monthlyPayment'),
            noLoanMessage: document.getElementById('noLoanMessage'),
            repaymentSection: document.getElementById('repaymentSection'),
            repaymentAmount: document.getElementById('repaymentAmount'),
            repayLoanBtn: document.getElementById('repayLoanBtn'),
            newLoanBtn: document.getElementById('newLoanBtn'),

            // Settings
            playerNameInput: document.getElementById('playerNameInput'),
            updateProfileBtn: document.getElementById('updateProfileBtn'),
            saveGameBtn: document.getElementById('saveGameBtn'),
            loadGameBtn: document.getElementById('loadGameBtn'),
            resetGameBtn: document.getElementById('resetGameBtn'),
            rewardNotifications: document.getElementById('rewardNotifications'),
            salaryNotifications: document.getElementById('salaryNotifications'),
            marketEventNotifications: document.getElementById('marketEventNotifications'),

            // Modals and notifications
            notificationToast: document.getElementById('notificationToast'),
            notificationTitle: document.getElementById('notificationTitle'),
            notificationMessage: document.getElementById('notificationMessage'),
            closeNotification: document.getElementById('closeNotification'),
            
            assetModal: document.getElementById('assetModal'),
            closeModal: document.getElementById('closeModal'),
            modalAssetIcon: document.getElementById('modalAssetIcon'),
            modalAssetName: document.getElementById('modalAssetName'),
            modalAssetCategory: document.getElementById('modalAssetCategory'),
            modalAssetPrice: document.getElementById('modalAssetPrice'),
            modalAssetReward: document.getElementById('modalAssetReward'),
            modalAssetROI: document.getElementById('modalAssetROI'),
            modalAssetGrowth: document.getElementById('modalAssetGrowth'),
            modalAssetDescription: document.getElementById('modalAssetDescription'),
            modalAssetActions: document.getElementById('modalAssetActions'),
            
            loanModal: document.getElementById('loanModal'),
            closeLoanModal: document.getElementById('closeLoanModal'),
            cancelLoanBtn: document.getElementById('cancelLoanBtn'),
            confirmLoanBtn: document.getElementById('confirmLoanBtn'),

            // NEW: Modal elements for new features
            tradingModal: document.getElementById('tradingModal'),
            closeTradingModal: document.getElementById('closeTradingModal'),
            tradeAssetSelect: document.getElementById('tradeAssetSelect'),
            tradePrice: document.getElementById('tradePrice'),
            tradeDescription: document.getElementById('tradeDescription'),
            cancelTradeBtn: document.getElementById('cancelTradeBtn'),
            confirmTradeBtn: document.getElementById('confirmTradeBtn'),

            businessModal: document.getElementById('businessModal'),
            closeBusinessModal: document.getElementById('closeBusinessModal'),
            businessTypes: document.getElementById('businessTypes'),
            cancelBusinessBtn: document.getElementById('cancelBusinessBtn'),
            confirmBusinessBtn: document.getElementById('confirmBusinessBtn'),

            stockModal: document.getElementById('stockModal'),
            closeStockModal: document.getElementById('closeStockModal'),
            stockSymbolSelect: document.getElementById('stockSymbolSelect'),
            shareQuantity: document.getElementById('shareQuantity'),
            currentStockPrice: document.getElementById('currentStockPrice'),
            totalStockCost: document.getElementById('totalStockCost'),
            stockCommission: document.getElementById('stockCommission'),
            cancelStockBtn: document.getElementById('cancelStockBtn'),
            confirmStockBtn: document.getElementById('confirmStockBtn'),

            insuranceModal: document.getElementById('insuranceModal'),
            closeInsuranceModal: document.getElementById('closeInsuranceModal'),
            insurancePolicies: document.getElementById('insurancePolicies'),
            cancelInsuranceBtn: document.getElementById('cancelInsuranceBtn'),
            confirmInsuranceBtn: document.getElementById('confirmInsuranceBtn'),
            
            researchInfoModal: document.getElementById('researchInfoModal'),
            closeResearchInfoModal: document.getElementById('closeResearchInfoModal'),
            closeResearchInfoBtn: document.getElementById('closeResearchInfoBtn'),
            
            refreshDashboard: document.getElementById('refreshDashboard')
        };

        // Enhanced Game State
        let gameState = JSON.parse(JSON.stringify(gameData));
        let gameInterval;
        let lastUpdateTime = Date.now();
        let activeSection = 'dashboard';
        let selectedLoanOption = null;
        let selectedBusinessType = null;
        let selectedInsuranceType = null;
        let chartsInitialized = false;
        let netWorthChart, incomeChart, assetDistChart, stockChart;

        // Initialize the enhanced game with all new features
        function initGame() {
            // Load saved game if available
            if (localStorage.getItem('assetMasterProEliteSave')) {
                loadGame();
            } else {
                // Initialize new features
                initializeStockMarket();
                generateQuests();
                generateLeaderboard();
                updateUI();
            }

            // Start game loop
            gameInterval = setInterval(gameLoop, 1000);

            // Setup event listeners
            setupEventListeners();
            
            // Initialize charts
            setTimeout(initCharts, 100);
        }

        // NEW: Initialize stock market with historical data
        function initializeStockMarket() {
            Object.keys(gameState.stockMarket.stocks).forEach(symbol => {
                const stock = gameState.stockMarket.stocks[symbol];
                // Generate initial price history (last 24 hours)
                stock.history = [];
                let currentPrice = stock.price;
                for (let i = 24; i >= 0; i--) {
                    const volatilityChange = (Math.random() - 0.5) * stock.volatility * currentPrice;
                    currentPrice = Math.max(currentPrice + volatilityChange, stock.price * 0.5);
                    stock.history.push(currentPrice);
                }
                stock.price = currentPrice;
            });
        }

        // NEW: Generate active quests for the player
        function generateQuests() {
            gameState.player.quests.active = [];
            
            // Add 3 random quests
            const availableQuests = [...gameState.questTemplates];
            for (let i = 0; i < 3; i++) {
                if (availableQuests.length === 0) break;
                
                const randomIndex = Math.floor(Math.random() * availableQuests.length);
                const questTemplate = availableQuests.splice(randomIndex, 1)[0];
                
                gameState.player.quests.active.push({
                    ...questTemplate,
                    progress: 0,
                    completed: false,
                    claimed: false
                });
            }
        }

        // Enhanced game loop with new features
        function gameLoop() {
            const now = Date.now();
            const deltaTime = (now - lastUpdateTime) / 1000; // Convert to seconds
            lastUpdateTime = now;

            // Update timers
            updateTimers(deltaTime);

            // Update asset values
            updateAssetValues(deltaTime);

            // NEW: Update stock prices
            updateStockPrices(deltaTime);

            // NEW: Update business income
            updateBusinessIncome(deltaTime);

            // Check for random market events
            checkMarketEvents(deltaTime);

            // Update level progression
            updateLevel();

            // NEW: Update quests
            updateQuests();

            // NEW: Update insurance policies
            updateInsurance(deltaTime);

            // Update UI
            updateUI();

            // Auto-save every 5 minutes
            if (gameState.player.lastUpdate + 300000 < now) {
                gameState.player.lastUpdate = now;
                saveGame();
            }
        }

        // NEW: Update stock prices with realistic volatility
        function updateStockPrices(deltaTime) {
            Object.keys(gameState.stockMarket.stocks).forEach(symbol => {
                const stock = gameState.stockMarket.stocks[symbol];
                
                // Random price movement based on volatility
                const change = (Math.random() - 0.5) * stock.volatility * stock.price * deltaTime;
                stock.price = Math.max(stock.price + change, stock.price * 0.1);
                
                // Update history every minute
                if (Math.random() < deltaTime / 60) {
                    stock.history.push(stock.price);
                    if (stock.history.length > 24) {
                        stock.history.shift();
                    }
                }
            });
        }

        // NEW: Update business income generation
        function updateBusinessIncome(deltaTime) {
            let totalIncome = 0;
            
            gameState.player.businesses.forEach(business => {
                const businessType = gameState.businessTypes.find(bt => bt.id === business.type);
                if (businessType) {
                    const hourlyIncome = businessType.baseIncome * Math.pow(1.5, business.level - 1);
                    const secondlyIncome = hourlyIncome / 3600;
                    const income = secondlyIncome * deltaTime;
                    
                    gameState.player.cash += income;
                    gameState.player.stats.lifetimeEarnings += income;
                    totalIncome += income;
                }
            });

            return totalIncome;
        }

        // NEW: Update quest progress
        function updateQuests() {
            gameState.player.quests.active.forEach(quest => {
                if (quest.completed) return;

                let progress = 0;
                switch (quest.type) {
                    case 'cumulative':
                        progress = gameState.player.stats.lifetimeEarnings;
                        break;
                    case 'count':
                        progress = gameState.player.assets.length;
                        break;
                    case 'level':
                        progress = gameState.player.level;
                        break;
                    case 'research':
                        progress = gameState.player.stats.researchPoints;
                        break;
                    case 'networth':
                        progress = gameState.player.netWorth;
                        break;
                }

                quest.progress = progress;
                
                if (progress >= quest.target && !quest.completed) {
                    quest.completed = true;
                    showNotification("Quest Completed!", `${quest.name} completed! Claim your reward of $${formatCurrency(quest.reward)}.`);
                }
            });
        }

        // NEW: Update insurance policies
        function updateInsurance(deltaTime) {
            gameState.player.insurance = gameState.player.insurance.filter(policy => {
                policy.timeRemaining -= deltaTime;
                if (policy.timeRemaining <= 0) {
                    showNotification("Insurance Expired", `Your ${policy.name} policy has expired.`, "warning");
                    return false;
                }
                return true;
            });
        }

        // Enhanced timer updates
        function updateTimers(deltaTime) {
            // Salary timer
            gameState.player.salaryTimer -= deltaTime;
            if (gameState.player.salaryTimer <= 0) {
                collectSalary();
                gameState.player.salaryTimer = 30 * 60; // Reset to 30 minutes
            }

            // Reward timer
            gameState.player.rewardTimer -= deltaTime;
            if (gameState.player.rewardTimer <= 0) {
                collectRewards();
                gameState.player.rewardTimer = 30 * 60; // Reset to 30 minutes
            }

            // Research timer (now 10 minutes)
            if (gameState.player.stats.researchTimer > 0) {
                gameState.player.stats.researchTimer -= deltaTime;
                if (gameState.player.stats.researchTimer <= 0) {
                    const researchRate = gameState.player.stats.badges.includes("Research Expert") ? 2 : 1;
                    gameState.player.stats.researchPoints += researchRate;
                    gameState.player.stats.researchTimer = 10 * 60; // Reset to 10 minutes
                    showNotification("Research Complete", `You've earned ${researchRate} research point${researchRate > 1 ? 's' : ''}!`);
                }
            }

            // Market event timer
            if (gameState.market.activeEvent) {
                gameState.market.eventTimer -= deltaTime;
                if (gameState.market.eventTimer <= 0) {
                    endMarketEvent();
                }
            }

            // Loan interest accumulation (every second)
            if (gameState.player.stats.loanDebt > 0) {
                const annualRate = gameState.player.stats.loanInterest / 100;
                const secondlyRate = annualRate / (365 * 24 * 60 * 60);
                const interestAccrued = gameState.player.stats.loanDebt * secondlyRate * deltaTime;
                gameState.player.stats.loanDebt += interestAccrued;
            }
        }

        // Enhanced level system
        function updateLevel() {
            const currentLevelData = gameState.levels.find(l => l.level === gameState.player.level);
            const nextLevelData = gameState.levels.find(l => l.level === gameState.player.level + 1);
            
            if (nextLevelData && gameState.player.netWorth >= nextLevelData.requirement) {
                gameState.player.level = nextLevelData.level;
                showNotification("Level Up!", `Welcome to ${nextLevelData.name}! Your salary has increased to $${nextLevelData.salary}.`, "success");
                
                // Add level-based badge
                if (!gameState.player.stats.badges.includes(nextLevelData.name)) {
                    gameState.player.stats.badges.push(nextLevelData.name);
                }
            }
        }

        // Enhanced salary collection with 4x multiplier after first payment
        function collectSalary() {
            const currentLevelData = gameState.levels.find(l => l.level === gameState.player.level);
            let salaryAmount = currentLevelData ? currentLevelData.salary : 100;
            
            // Apply 4x multiplier after first salary (if salaryCount > 0)
            if (gameState.player.salaryCount > 0) {
                salaryAmount *= 4;
            }
            
            gameState.player.cash += salaryAmount;
            gameState.player.stats.lifetimeEarnings += salaryAmount;
            gameState.player.salaryCount++;

            if (gameState.player.settings.salaryNotifications) {
                const multiplierText = gameState.player.salaryCount > 1 ? " (4x multiplier applied!)" : "";
                showNotification("Salary Received", `You received $${formatCurrency(salaryAmount)} salary!${multiplierText}`);
            }

            updateNetWorth();
        }

        // Enhanced asset value updates
        function updateAssetValues(deltaTime) {
            let totalPassiveIncome = 0;

            gameState.market.assets.forEach(asset => {
                if (asset.owned) {
                    // Apply appreciation
                    const appreciation = asset.price * asset.appreciationRate * deltaTime;
                    asset.price += appreciation;

                    // Add to passive income
                    totalPassiveIncome += asset.reward * deltaTime / (30 * 60); // Reward per 30min converted to per second

                    // Check for volatility (tech assets)
                    if (asset.volatility) {
                        const randomChange = (Math.random() * 2 - 1) * asset.volatility * asset.price * deltaTime / (60 * 60);
                        asset.price += randomChange;
                        
                        // Ensure price doesn't go below 10% of base price
                        if (asset.price < asset.basePrice * 0.1) {
                            asset.price = asset.basePrice * 0.1;
                        }
                    }
                }
            });

            // Add passive income to cash (automatically)
            gameState.player.cash += totalPassiveIncome;
            gameState.player.stats.lifetimeEarnings += totalPassiveIncome;

            // Update net worth
            updateNetWorth();
        }

        // Enhanced net worth calculation including stocks and businesses
        function updateNetWorth() {
            let totalAssetsValue = 0;
            let totalStocksValue = 0;
            let totalBusinessValue = 0;

            // Calculate assets value
            gameState.market.assets.forEach(asset => {
                if (asset.owned) {
                    totalAssetsValue += asset.price;
                }
            });

            // Calculate stocks value
            Object.keys(gameState.player.stocks).forEach(symbol => {
                const holding = gameState.player.stocks[symbol];
                const currentPrice = gameState.stockMarket.stocks[symbol].price;
                totalStocksValue += holding.shares * currentPrice;
            });

            // Calculate business value
            gameState.player.businesses.forEach(business => {
                const businessType = gameState.businessTypes.find(bt => bt.id === business.type);
                if (businessType) {
                    totalBusinessValue += businessType.basePrice * Math.pow(1.3, business.level - 1);
                }
            });

            // Accurate net worth calculation: Cash + Assets + Stocks + Businesses - Debt
            gameState.player.netWorth = gameState.player.cash + totalAssetsValue + totalStocksValue + totalBusinessValue - gameState.player.stats.loanDebt;

            // Calculate ROI based on initial investment vs current net worth
            const initialAmount = 5000;
            if (gameState.player.stats.totalInvested > 0 || gameState.player.netWorth !== initialAmount) {
                const profit = gameState.player.netWorth - initialAmount;
                gameState.player.stats.roi = (profit / initialAmount) * 100;
            }
            
            // Update net worth history for chart
            gameState.player.netWorthHistory.shift();
            gameState.player.netWorthHistory.push(gameState.player.netWorth);
            
            // Update leaderboard entry
            updateLeaderboardEntry();
        }

        // Enhanced asset buying (money automatically deducted)
        function buyAsset(assetId) {
            const asset = gameState.market.assets.find(a => a.id === assetId);

            if (!asset || asset.owned) return;

            if (gameState.player.cash >= asset.price) {
                gameState.player.cash -= asset.price; // Automatically deduct from balance
                asset.owned = true;
                gameState.player.assets.push(asset.id);
                gameState.player.stats.totalInvested += asset.price;

                // Check for achievement
                if (gameState.player.assets.length === 1 && !gameState.player.stats.badges.includes("First Asset")) {
                    gameState.player.stats.badges.push("First Asset");
                    showNotification("Achievement Unlocked", "You've purchased your first asset!");
                }

                updateNetWorth();
                updateUI();
                saveGame();

                showNotification("Purchase Complete", `You've purchased ${asset.name} for $${formatCurrency(asset.price)}`);
            } else {
                showNotification("Insufficient Funds", "You don't have enough cash to buy this asset.", "error");
            }
        }

        // Enhanced asset selling (money automatically added)
        function sellAsset(assetId) {
            const asset = gameState.market.assets.find(a => a.id === assetId);

            if (!asset || !asset.owned) return;

            // Calculate sale price (95% of current value to simulate fees)
            const salePrice = asset.price * 0.95;
            gameState.player.cash += salePrice; // Automatically add to balance
            asset.owned = false;

            // Remove from player's assets
            const assetIndex = gameState.player.assets.indexOf(assetId);
            if (assetIndex > -1) {
                gameState.player.assets.splice(assetIndex, 1);
            }

            updateNetWorth();
            updateUI();
            saveGame();

            showNotification("Asset Sold", `You've sold ${asset.name} for $${formatCurrency(salePrice)} (5% fee deducted)`);
        }

        // NEW: Buy stocks function
        function buyStocks(symbol, shares) {
            const stock = gameState.stockMarket.stocks[symbol];
            if (!stock) return;

            const totalCost = stock.price * shares;
            const commission = totalCost * 0.02; // 2% commission
            const finalCost = totalCost + commission;

            if (gameState.player.cash >= finalCost) {
                gameState.player.cash -= finalCost;
                
                if (!gameState.player.stocks[symbol]) {
                    gameState.player.stocks[symbol] = { shares: 0, avgPrice: 0 };
                }
                
                const holding = gameState.player.stocks[symbol];
                const totalShares = holding.shares + shares;
                holding.avgPrice = ((holding.avgPrice * holding.shares) + (stock.price * shares)) / totalShares;
                holding.shares = totalShares;

                updateNetWorth();
                updateUI();
                saveGame();

                showNotification("Stocks Purchased", `Bought ${shares} shares of ${symbol} for $${formatCurrency(finalCost)} (including commission)`);
            } else {
                showNotification("Insufficient Funds", "You don't have enough cash to buy these stocks.", "error");
            }
        }

        // NEW: Sell stocks function
        function sellStocks(symbol, shares) {
            const stock = gameState.stockMarket.stocks[symbol];
            const holding = gameState.player.stocks[symbol];
            
            if (!stock || !holding || holding.shares < shares) return;

            const totalValue = stock.price * shares;
            const commission = totalValue * 0.02; // 2% commission
            const finalValue = totalValue - commission;

            gameState.player.cash += finalValue;
            holding.shares -= shares;

            if (holding.shares === 0) {
                delete gameState.player.stocks[symbol];
            }

            updateNetWorth();
            updateUI();
            saveGame();

            showNotification("Stocks Sold", `Sold ${shares} shares of ${symbol} for $${formatCurrency(finalValue)} (commission deducted)`);
        }

        // NEW: Create business function
        function createBusiness(businessTypeId) {
            const businessType = gameState.businessTypes.find(bt => bt.id === businessTypeId);
            if (!businessType) return;

            if (gameState.player.cash >= businessType.basePrice) {
                gameState.player.cash -= businessType.basePrice;
                
                const newBusiness = {
                    id: Math.random().toString(36).substr(2, 9),
                    type: businessTypeId,
                    level: 1,
                    employees: 1,
                    createdAt: Date.now()
                };

                gameState.player.businesses.push(newBusiness);

                updateNetWorth();
                updateUI();
                saveGame();

                showNotification("Business Created", `Successfully launched your ${businessType.name}!`);
            } else {
                showNotification("Insufficient Funds", "You don't have enough cash to start this business.", "error");
            }
        }

        // NEW: Upgrade business function
        function upgradeBusiness(businessId) {
            const business = gameState.player.businesses.find(b => b.id === businessId);
            const businessType = gameState.businessTypes.find(bt => bt.id === business.type);
            
            if (!business || !businessType || business.level >= businessType.maxLevel) return;

            const upgradeCost = businessType.basePrice * Math.pow(1.5, business.level);

            if (gameState.player.cash >= upgradeCost) {
                gameState.player.cash -= upgradeCost;
                business.level++;
                business.employees = Math.floor(business.employees * 1.2);

                updateNetWorth();
                updateUI();
                saveGame();

                showNotification("Business Upgraded", `${businessType.name} upgraded to level ${business.level}!`);
            } else {
                showNotification("Insufficient Funds", "You don't have enough cash to upgrade this business.", "error");
            }
        }

        // NEW: Create trade function
        function createTrade(assetId, price, description) {
            const asset = gameState.market.assets.find(a => a.id === assetId);
            if (!asset || !asset.owned) return;

            const trade = {
                id: Math.random().toString(36).substr(2, 9),
                sellerId: gameState.player.id,
                sellerName: gameState.player.name,
                assetId: assetId,
                assetName: asset.name,
                assetIcon: asset.image,
                price: price,
                description: description,
                createdAt: Date.now()
            };

            gameState.tradingHub.activeTrades.push(trade);

            // Remove asset from player (in escrow)
            asset.owned = false;
            const assetIndex = gameState.player.assets.indexOf(assetId);
            if (assetIndex > -1) {
                gameState.player.assets.splice(assetIndex, 1);
            }

            updateNetWorth();
            updateUI();
            saveGame();

            showNotification("Trade Created", `Your ${asset.name} is now listed for $${formatCurrency(price)}`);
        }

        // NEW: Execute trade function
        function executeTrade(tradeId) {
            const trade = gameState.tradingHub.activeTrades.find(t => t.id === tradeId);
            if (!trade) return;

            if (gameState.player.cash >= trade.price) {
                gameState.player.cash -= trade.price;
                
                // Give asset to buyer
                const asset = gameState.market.assets.find(a => a.id === trade.assetId);
                asset.owned = true;
                gameState.player.assets.push(trade.assetId);

                // Remove from active trades
                const tradeIndex = gameState.tradingHub.activeTrades.indexOf(trade);
                gameState.tradingHub.activeTrades.splice(tradeIndex, 1);

                // Move to completed trades
                gameState.tradingHub.completedTrades.push({
                    ...trade,
                    buyerId: gameState.player.id,
                    buyerName: gameState.player.name,
                    completedAt: Date.now()
                });

                // Update trading stats
                gameState.player.tradingStats.totalTrades++;
                gameState.player.tradingStats.successfulTrades++;

                updateNetWorth();
                updateUI();
                saveGame();

                showNotification("Trade Executed", `Successfully purchased ${trade.assetName} for $${formatCurrency(trade.price)}`);
            } else {
                showNotification("Insufficient Funds", "You don't have enough cash to complete this trade.", "error");
            }
        }

        // NEW: Claim daily bonus function
        function claimDailyBonus() {
            const now = Date.now();
            const lastLogin = gameState.player.quests.daily.lastLogin;
            const daysSinceLastLogin = Math.floor((now - lastLogin) / (24 * 60 * 60 * 1000));

            if (gameState.player.quests.daily.bonusClaimed) {
                showNotification("Already Claimed", "You've already claimed today's bonus!", "warning");
                return;
            }

            let streak = gameState.player.quests.daily.loginStreak;
            if (daysSinceLastLogin === 1) {
                // Continue streak
                streak++;
            } else if (daysSinceLastLogin > 1) {
                // Reset streak
                streak = 1;
            }

            // Calculate bonus based on streak
            const bonusAmounts = [100, 200, 500, 1000, 2000, 5000, 10000];
            const dayIndex = Math.min(streak - 1, bonusAmounts.length - 1);
            const bonus = bonusAmounts[dayIndex];

            gameState.player.cash += bonus;
            gameState.player.stats.lifetimeEarnings += bonus;
            gameState.player.quests.daily.loginStreak = streak;
            gameState.player.quests.daily.lastLogin = now;
            gameState.player.quests.daily.bonusClaimed = true;

            updateNetWorth();
            updateUI();
            saveGame();

            showNotification("Daily Bonus Claimed", `You received $${formatCurrency(bonus)}! Login streak: ${streak} days`);
        }

        // NEW: Claim quest reward function
        function claimQuestReward(questId) {
            const quest = gameState.player.quests.active.find(q => q.id === questId);
            if (!quest || !quest.completed || quest.claimed) return;

            gameState.player.cash += quest.reward;
            gameState.player.stats.lifetimeEarnings += quest.reward;
            quest.claimed = true;

            // Remove completed quest and add new one
            setTimeout(() => {
                const questIndex = gameState.player.quests.active.indexOf(quest);
                gameState.player.quests.active.splice(questIndex, 1);

                // Add new random quest
                const completedQuestIds = gameState.player.quests.active.map(q => q.id);
                const availableQuests = gameState.questTemplates.filter(qt => !completedQuestIds.includes(qt.id));
                
                if (availableQuests.length > 0) {
                    const randomQuest = availableQuests[Math.floor(Math.random() * availableQuests.length)];
                    gameState.player.quests.active.push({
                        ...randomQuest,
                        progress: 0,
                        completed: false,
                        claimed: false
                    });
                }

                updateUI();
            }, 1000);

            updateNetWorth();
            updateUI();
            saveGame();

            showNotification("Quest Reward Claimed", `You received $${formatCurrency(quest.reward)}!`);
        }

        // NEW: Buy insurance function
        function buyInsurance(insuranceTypeId) {
            const insuranceType = gameState.insuranceTypes.find(it => it.id === insuranceTypeId);
            if (!insuranceType) return;

            if (gameState.player.cash >= insuranceType.cost) {
                gameState.player.cash -= insuranceType.cost;

                const policy = {
                    ...insuranceType,
                    purchasedAt: Date.now(),
                    timeRemaining: insuranceType.duration
                };

                gameState.player.insurance.push(policy);

                updateNetWorth();
                updateUI();
                saveGame();

                showNotification("Insurance Purchased", `You're now protected with ${insuranceType.name} for 30 days.`);
            } else {
                showNotification("Insufficient Funds", "You don't have enough cash to buy this insurance.", "error");
            }
        }

        // Manual loan repayment function
        function repayLoan() {
            const repaymentAmount = parseFloat(elements.repaymentAmount.value);
            
            if (!repaymentAmount || repaymentAmount <= 0) {
                showNotification("Invalid Amount", "Please enter a valid repayment amount.", "error");
                return;
            }
            
            if (repaymentAmount > gameState.player.cash) {
                showNotification("Insufficient Funds", "You don't have enough cash for this repayment.", "error");
                return;
            }
            
            if (repaymentAmount > gameState.player.stats.loanDebt) {
                showNotification("Amount Too High", "Repayment amount exceeds your debt.", "error");
                return;
            }
            
            // Process repayment
            gameState.player.cash -= repaymentAmount;
            gameState.player.stats.loanDebt -= repaymentAmount;
            
            // Record repayment history
            gameState.player.stats.loanRepaymentHistory.push({
                amount: repaymentAmount,
                date: Date.now(),
                remainingDebt: gameState.player.stats.loanDebt
            });
            
            // Clear loan data if fully repaid
            if (gameState.player.stats.loanDebt <= 0.01) { // Account for floating point precision
                gameState.player.stats.loanDebt = 0;
                gameState.player.stats.loanInterest = 0;
                showNotification("Loan Paid Off!", "Congratulations! You've successfully paid off your loan.", "success");
            } else {
                showNotification("Payment Processed", `$${formatCurrency(repaymentAmount)} repaid. Remaining debt: $${formatCurrency(gameState.player.stats.loanDebt)}`);
            }
            
            // Clear input and update UI
            elements.repaymentAmount.value = '';
            updateNetWorth();
            updateUI();
            saveGame();
        }

        // Enhanced UI update with all new features
        function updateUI() {
            // Update player stats
            elements.walletAmount.textContent = `$${formatCurrency(gameState.player.cash)}`;
            elements.netWorth.textContent = `$${formatCurrency(gameState.player.netWorth)}`;
            elements.roiStat.textContent = `${gameState.player.stats.roi.toFixed(2)}%`;
            elements.assetsCount.textContent = gameState.player.assets.length;
            elements.lifetimeEarnings.textContent = `$${formatCurrency(gameState.player.stats.lifetimeEarnings)}`;
            elements.playerName.textContent = gameState.player.name;

            // Update level system
            const currentLevelData = gameState.levels.find(l => l.level === gameState.player.level);
            const nextLevelData = gameState.levels.find(l => l.level === gameState.player.level + 1);
            
            elements.currentLevel.textContent = gameState.player.level;
            elements.sidebarLevel.textContent = gameState.player.level;
            elements.dashboardLevel.textContent = gameState.player.level;
            
            if (currentLevelData) {
                const baseSalary = currentLevelData.salary;
                const actualSalary = gameState.player.salaryCount > 0 ? baseSalary * 4 : baseSalary;
                elements.salaryAmount.textContent = formatCurrency(actualSalary);
            }
            
            if (nextLevelData) {
                elements.nextLevelSalary.textContent = formatCurrency(nextLevelData.salary * 4);
                elements.nextLevelAmount.textContent = `Next: $${formatCurrency(nextLevelData.requirement)}`;
                
                // Update level progress
                const currentReq = currentLevelData ? currentLevelData.requirement : 0;
                const nextReq = nextLevelData.requirement;
                const progress = Math.min(((gameState.player.netWorth - currentReq) / (nextReq - currentReq)) * 100, 100);
                elements.levelProgressFill.style.width = `${Math.max(progress, 0)}%`;
            } else {
                elements.nextLevelAmount.textContent = "Max Level";
                elements.levelProgressFill.style.width = "100%";
            }

            // Update enhanced net worth breakdown
            const totalAssetsValue = gameState.market.assets
                .filter(asset => asset.owned)
                .reduce((sum, asset) => sum + asset.price, 0);
            
            const totalStocksValue = Object.keys(gameState.player.stocks).reduce((sum, symbol) => {
                const holding = gameState.player.stocks[symbol];
                const currentPrice = gameState.stockMarket.stocks[symbol].price;
                return sum + (holding.shares * currentPrice);
            }, 0);

            const totalBusinessValue = gameState.player.businesses.reduce((sum, business) => {
                const businessType = gameState.businessTypes.find(bt => bt.id === business.type);
                return sum + (businessType ? businessType.basePrice * Math.pow(1.3, business.level - 1) : 0);
            }, 0);
            
            elements.cashBreakdown.textContent = `$${formatCurrency(gameState.player.cash)}`;
            elements.assetsBreakdown.textContent = `$${formatCurrency(totalAssetsValue)}`;
            elements.stocksBreakdown.textContent = `$${formatCurrency(totalStocksValue)}`;
            elements.businessBreakdown.textContent = `$${formatCurrency(totalBusinessValue)}`;
            elements.debtBreakdown.textContent = `-$${formatCurrency(gameState.player.stats.loanDebt)}`;
            elements.totalNetWorth.textContent = `$${formatCurrency(gameState.player.netWorth)}`;

            // Update loan debt indicator
            if (gameState.player.stats.loanDebt > 0) {
                elements.loanDebtIndicator.style.display = 'flex';
                elements.debtAmount.textContent = formatCurrency(gameState.player.stats.loanDebt);
            } else {
                elements.loanDebtIndicator.style.display = 'none';
            }

            // Update badges
            updateBadges();

            // Update leaderboard rank
            const playerRank = gameState.leaderboard.findIndex(p => p.id === gameState.player.id) + 1;
            elements.leaderboardRank.textContent = playerRank;

            // Update dashboard widgets
            elements.netWorthWidget.textContent = `$${formatCurrency(gameState.player.netWorth)}`;

            // Calculate passive income per 30min
            let passiveIncome = 0;
            let activeAssets = 0;
            gameState.market.assets.forEach(asset => {
                if (asset.owned) {
                    passiveIncome += asset.reward;
                    activeAssets++;
                }
            });
            elements.passiveIncomeWidget.textContent = `$${formatCurrency(passiveIncome)}/30min`;
            elements.activeAssetsCount.textContent = activeAssets;
            
            // Calculate net worth growth
            const lastNetWorth = gameState.player.netWorthHistory[gameState.player.netWorthHistory.length - 2];
            const currentNetWorth = gameState.player.netWorthHistory[gameState.player.netWorthHistory.length - 1];
            const growth = lastNetWorth > 0 ? ((currentNetWorth - lastNetWorth) / lastNetWorth) * 100 : 0;
            
            elements.netWorthGrowth.classList.remove('positive', 'negative');
            if (growth > 0) {
                elements.netWorthGrowth.innerHTML = `<i class="fas fa-arrow-up"></i> ${growth.toFixed(2)}%`;
                elements.netWorthGrowth.classList.add('positive');
            } else if (growth < 0) {
                elements.netWorthGrowth.innerHTML = `<i class="fas fa-arrow-down"></i> ${Math.abs(growth).toFixed(2)}%`;
                elements.netWorthGrowth.classList.add('negative');
            } else {
                elements.netWorthGrowth.innerHTML = `<i class="fas fa-minus"></i> 0%`;
            }
            
            // Calculate income growth (simulated)
            const incomeGrowth = passiveIncome > 0 ? Math.min(25, Math.random() * 30) : 0;
            elements.incomeGrowth.innerHTML = `<i class="fas fa-arrow-up"></i> ${incomeGrowth.toFixed(2)}%`;

            // Update timers
            elements.nextSalaryWidget.textContent = formatTime(gameState.player.salaryTimer);
            elements.nextRewardWidget.textContent = formatTime(gameState.player.rewardTimer);
            elements.nextResearchPoint.textContent = formatTime(gameState.player.stats.researchTimer);
            
            // Update progress bars
            elements.salaryProgress.style.width = `${((30 * 60 - gameState.player.salaryTimer) / (30 * 60)) * 100}%`;
            elements.rewardProgress.style.width = `${((30 * 60 - gameState.player.rewardTimer) / (30 * 60)) * 100}%`;
            elements.researchProgress.style.width = `${((10 * 60 - gameState.player.stats.researchTimer) / (10 * 60)) * 100}%`;

            // Update research points
            elements.researchPoints.textContent = gameState.player.stats.researchPoints;
            
            // Update research rate
            const researchRate = gameState.player.stats.badges.includes("Research Expert") ? 2 : 1;
            elements.researchRate.textContent = `${researchRate}/10min`;

            // NEW: Update quest dashboard widget
            const activeQuests = gameState.player.quests.active.length;
            const completedQuests = gameState.player.quests.active.filter(q => q.completed).length;
            const questProgress = activeQuests > 0 ? (completedQuests / activeQuests) * 100 : 0;
            
            elements.activeQuestsCount.textContent = activeQuests;
            elements.questProgressWidget.textContent = `${questProgress.toFixed(0)}%`;
            elements.loginStreak.textContent = gameState.player.quests.daily.loginStreak;
            elements.streakProgress.style.width = `${(gameState.player.quests.daily.loginStreak / 7) * 100}%`;

            // NEW: Update trading stats
            elements.successfulTrades.textContent = gameState.player.tradingStats.successfulTrades;
            elements.totalTrades.textContent = gameState.player.tradingStats.totalTrades;
            elements.tradingProfit.textContent = formatCurrency(gameState.player.tradingStats.tradingProfit);
            elements.tradingRank.textContent = calculateTradingRank();

            // NEW: Update business stats
            elements.totalBusinesses.textContent = gameState.player.businesses.length;
            
            let totalBusinessIncome = 0;
            let totalEmployees = 0;
            gameState.player.businesses.forEach(business => {
                const businessType = gameState.businessTypes.find(bt => bt.id === business.type);
                if (businessType) {
                    totalBusinessIncome += businessType.baseIncome * Math.pow(1.5, business.level - 1);
                    totalEmployees += business.employees;
                }
            });
            
            elements.businessIncome.textContent = formatCurrency(totalBusinessIncome);
            elements.totalEmployees.textContent = totalEmployees;
            elements.businessValue.textContent = formatCurrency(totalBusinessValue);

            // Update market event banner
            if (gameState.market.activeEvent) {
                elements.marketEventBanner.classList.add('active');
                elements.marketEventTitle.textContent = gameState.market.activeEvent.name;
                elements.marketEventDescription.textContent = gameState.market.activeEvent.description;
                elements.marketEventTimer.textContent = formatTime(gameState.market.eventTimer);
            } else {
                elements.marketEventBanner.classList.remove('active');
            }

            // Update loan center
            updateLoanCenter();

            // Update current section
            updateCurrentSection();
            
            // Update charts
            updateCharts();
        }

        // NEW: Calculate trading rank
        function calculateTradingRank() {
            const successRate = gameState.player.tradingStats.totalTrades > 0 
                ? (gameState.player.tradingStats.successfulTrades / gameState.player.tradingStats.totalTrades) * 100 
                : 0;
            
            if (successRate >= 90) return "Elite";
            if (successRate >= 75) return "Expert";
            if (successRate >= 60) return "Advanced";
            if (successRate >= 40) return "Intermediate";
            return "Novice";
        }

        // Update loan center display
        function updateLoanCenter() {
            if (gameState.player.stats.loanDebt > 0) {
                elements.noLoanMessage.style.display = 'none';
                elements.currentDebt.textContent = formatCurrency(gameState.player.stats.loanDebt);
                elements.currentInterest.textContent = gameState.player.stats.loanInterest;
                elements.monthlyPayment.textContent = formatCurrency(gameState.player.stats.loanDebt * (gameState.player.stats.loanInterest / 100) / 12);
                elements.repaymentSection.style.display = 'block';
            } else {
                elements.noLoanMessage.style.display = 'block';
                elements.repaymentSection.style.display = 'none';
            }
        }

        // Enhanced marketplace display
        function updateMarketplace() {
            const categoryFilter = elements.categoryFilter.value;
            const sortFilter = elements.sortFilter.value;
            const searchQuery = elements.assetSearch.value.toLowerCase();

            // Filter assets
            let filteredAssets = gameState.market.assets.filter(asset => {
                const matchesCategory = categoryFilter === 'all' || asset.category === categoryFilter;
                const matchesSearch = asset.name.toLowerCase().includes(searchQuery) ||
                                      asset.category.toLowerCase().includes(searchQuery);
                return matchesCategory && matchesSearch && asset.unlocked;
            });

            // Sort assets
            switch (sortFilter) {
                case 'roi-desc':
                    filteredAssets.sort((a, b) => (b.reward / b.price) - (a.reward / a.price));
                    break;
                case 'roi-asc':
                    filteredAssets.sort((a, b) => (a.reward / a.price) - (b.reward / b.price));
                    break;
                case 'price-desc':
                    filteredAssets.sort((a, b) => b.price - a.price);
                    break;
                case 'price-asc':
                    filteredAssets.sort((a, b) => a.price - b.price);
                    break;
                case 'reward-desc':
                    filteredAssets.sort((a, b) => b.reward - a.reward);
                    break;
            }

            // Generate HTML for assets
            let html = '';
            filteredAssets.forEach(asset => {
                const roi = ((asset.reward / asset.price) * 100).toFixed(2);
                const priceChange = ((asset.price - asset.basePrice) / asset.basePrice * 100).toFixed(2);
                const priceChangeClass = priceChange >= 0 ? 'positive' : 'negative';
                const priceChangeIcon = priceChange >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                const canAfford = gameState.player.cash >= asset.price;

                html += `
                <div class="asset-card fade-in" data-id="${asset.id}">
                    <div class="asset-image">
                        ${asset.image}
                    </div>
                    <div class="asset-details">
                        <span class="asset-category">${asset.category.replace('-', ' ')}</span>
                        <h3 class="asset-name">${asset.name}</h3>
                        
                        <div class="asset-stats">
                            <div class="asset-stat">
                                <div class="stat-label">ROI</div>
                                <div class="stat-value">${roi}%</div>
                            </div>
                            <div class="asset-stat">
                                <div class="stat-label">Reward</div>
                                <div class="stat-value">$${formatCurrency(asset.reward)}/30min</div>
                            </div>
                        </div>
                        
                        <div class="asset-price">$${formatCurrency(asset.price)}
                            <div class="widget-growth ${priceChangeClass}" style="margin-top: 8px;">
                                <i class="fas ${priceChangeIcon}"></i> ${Math.abs(priceChange)}%
                            </div>
                        </div>
                        
                        <div class="asset-actions">
                            <button class="btn ${asset.owned ? 'btn-success' : 'btn-primary'} btn-asset buy-btn" ${(!canAfford && !asset.owned) || asset.owned ? 'disabled' : ''}>
                                <i class="fas ${asset.owned ? 'fa-check' : 'fa-shopping-cart'}"></i> ${asset.owned ? 'Owned' : 'Buy'}
                            </button>
                            <button class="btn btn-outline btn-asset info-btn">
                                <i class="fas fa-info-circle"></i> Details
                            </button>
                        </div>
                    </div>
                </div>
                `;
            });

            elements.assetGrid.innerHTML = html || '<div class="widget" style="text-align: center; padding: 40px;"><i class="fas fa-search" style="font-size: 60px; margin-bottom: 20px; opacity: 0.3;"></i><h3>No assets found</h3><p>Try adjusting your search criteria.</p></div>';

            // Add event listeners to buy buttons
            document.querySelectorAll('.buy-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const assetId = this.closest('.asset-card').dataset.id;
                    const asset = gameState.market.assets.find(a => a.id === assetId);
                    if (!asset.owned) {
                        buyAsset(assetId);
                    }
                });
            });
            
            // Add event listeners to info buttons
            document.querySelectorAll('.info-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const assetId = this.closest('.asset-card').dataset.id;
                    showAssetDetails(assetId);
                });
            });
        }

        // Enhanced portfolio display
        function updatePortfolio() {
            let html = '';
            let totalValue = 0;
            let totalReward = 0;
            let ownedAssets = [];

            gameState.market.assets.forEach(asset => {
                if (asset.owned) {
                    ownedAssets.push(asset);
                    totalValue += asset.price;
                    totalReward += asset.reward;
                }
            });

            if (ownedAssets.length === 0) {
                html = '<div class="widget" style="text-align: center; padding: 40px;"><i class="fas fa-briefcase" style="font-size: 60px; margin-bottom: 20px; opacity: 0.3;"></i><h3>Portfolio Empty</h3><p>Visit the marketplace to build your investment portfolio!</p><button class="btn btn-primary" style="margin-top: 20px;" onclick="switchToSection(\'marketplace\')"><i class="fas fa-store"></i> Browse Marketplace</button></div>';
            } else {
                // Add enhanced portfolio summary
                const avgROI = totalValue > 0 ? ((totalReward / totalValue) * 100).toFixed(2) : '0.00';
                const portfolioGrowth = ownedAssets.reduce((sum, asset) => {
                    return sum + ((asset.price - asset.basePrice) / asset.basePrice * 100);
                }, 0) / ownedAssets.length;

                html = `<div class="widget" style="margin-bottom: 30px;">
                    <div class="widget-header">
                        <div class="widget-title">Portfolio Analytics</div>
                        <div class="widget-growth ${portfolioGrowth >= 0 ? 'positive' : 'negative'}">
                            <i class="fas ${portfolioGrowth >= 0 ? 'fa-arrow-up' : 'fa-arrow-down'}"></i> ${Math.abs(portfolioGrowth).toFixed(2)}%
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; padding: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--secondary);">$${formatCurrency(totalValue)}</div>
                            <div style="font-size: 12px; opacity: 0.7; text-transform: uppercase;">Total Value</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--success);">$${formatCurrency(totalReward)}</div>
                            <div style="font-size: 12px; opacity: 0.7; text-transform: uppercase;">Income/30min</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${avgROI}%</div>
                            <div style="font-size: 12px; opacity: 0.7; text-transform: uppercase;">Average ROI</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--warning);">${ownedAssets.length}</div>
                            <div style="font-size: 12px; opacity: 0.7; text-transform: uppercase;">Total Assets</div>
                        </div>
                    </div>
                </div>`;

                ownedAssets.forEach(asset => {
                    const roi = ((asset.reward / asset.price) * 100).toFixed(2);
                    const growth = (asset.appreciationRate * 3600 * 100).toFixed(2);
                    const profit = asset.price - asset.basePrice;
                    const profitPercent = ((profit / asset.basePrice) * 100).toFixed(2);

                    html += `
                    <div class="asset-item fade-in" data-id="${asset.id}" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02)); border: 1px solid rgba(110, 69, 226, 0.3); border-radius: 15px; padding: 20px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center;">
                            <div style="font-size: 40px; margin-right: 20px;">
                                ${asset.image}
                            </div>
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h3 style="font-size: 20px; font-weight: 700; margin: 0;">${asset.name}</h3>
                                    <div style="font-size: 22px; font-weight: 700; color: var(--secondary);">$${formatCurrency(asset.price)}</div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; font-size: 14px;">
                                    <div><i class="fas fa-coins" style="margin-right: 8px; color: var(--warning);"></i>$${formatCurrency(asset.reward)}/30min</div>
                                    <div><i class="fas fa-percentage" style="margin-right: 8px; color: var(--info);"></i>${roi}% ROI</div>
                                    <div><i class="fas fa-arrow-up" style="margin-right: 8px; color: var(--success);"></i>${growth}%/hr</div>
                                    <div class="${profit >= 0 ? 'positive-value' : 'negative-value'}">
                                        <i class="fas ${profit >= 0 ? 'fa-plus' : 'fa-minus'}" style="margin-right: 8px;"></i> 
                                        ${profitPercent}% P/L
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 10px; margin-left: 20px;">
                                <button class="btn btn-outline info-btn" style="padding: 8px 16px;">
                                    <i class="fas fa-info-circle"></i> Details
                                </button>
                                <button class="btn btn-danger sell-btn" style="padding: 8px 16px;">
                                    <i class="fas fa-dollar-sign"></i> Sell
                                </button>
                            </div>
                        </div>
                    </div>
                    `;
                });
            }

            elements.assetsList.innerHTML = html;

            // Add event listeners to sell buttons
            document.querySelectorAll('.sell-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const assetId = this.closest('.asset-item').dataset.id;
                    sellAsset(assetId);
                });
            });
            
            // Add event listeners to info buttons
            document.querySelectorAll('.info-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const assetId = this.closest('.asset-item').dataset.id;
                    showAssetDetails(assetId);
                });
            });
        }

        // NEW: Update stock market section
        function updateStockMarket() {
            // Update stock ticker
            let tickerHTML = '';
            Object.keys(gameState.stockMarket.stocks).forEach(symbol => {
                const stock = gameState.stockMarket.stocks[symbol];
                const change = stock.history.length > 1 
                    ? ((stock.price - stock.history[stock.history.length - 2]) / stock.history[stock.history.length - 2] * 100).toFixed(2)
                    : 0;
                const changeClass = change >= 0 ? 'positive-value' : 'negative-value';
                const changeIcon = change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';

                tickerHTML += `
                    <div class="stock-item">
                        <strong>${symbol}</strong>
                        <span>$${stock.price.toFixed(2)}</span>
                        <span class="${changeClass}">
                            <i class="fas ${changeIcon}"></i> ${Math.abs(change)}%
                        </span>
                    </div>
                `;
            });
            elements.stockTicker.innerHTML = tickerHTML;

            // Update stock portfolio
            let portfolioHTML = '';
            const hasStocks = Object.keys(gameState.player.stocks).length > 0;

            if (!hasStocks) {
                portfolioHTML = '<div style="text-align: center; padding: 30px; opacity: 0.7;"><i class="fas fa-chart-line" style="font-size: 48px; margin-bottom: 15px;"></i><p>No stock holdings. Start investing to build your portfolio!</p></div>';
            } else {
                Object.keys(gameState.player.stocks).forEach(symbol => {
                    const holding = gameState.player.stocks[symbol];
                    const stock = gameState.stockMarket.stocks[symbol];
                    const currentValue = holding.shares * stock.price;
                    const costBasis = holding.shares * holding.avgPrice;
                    const profit = currentValue - costBasis;
                    const profitPercent = ((profit / costBasis) * 100).toFixed(2);

                    portfolioHTML += `
                        <div style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 18px; font-weight: 700;">${symbol}</div>
                                <div style="font-size: 14px; opacity: 0.7;">${holding.shares} shares @ avg $${holding.avgPrice.toFixed(2)}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 18px; font-weight: 700;">$${formatCurrency(currentValue)}</div>
                                <div class="${profit >= 0 ? 'positive-value' : 'negative-value'}" style="font-size: 14px;">
                                    ${profit >= 0 ? '+' : ''}$${formatCurrency(profit)} (${profitPercent}%)
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-danger btn-sm" onclick="sellStocks('${symbol}', ${holding.shares})" style="padding: 5px 10px; font-size: 12px;">
                                    <i class="fas fa-minus"></i> Sell All
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            elements.stockPortfolio.innerHTML = portfolioHTML;

            // Update stock portfolio growth
            let totalPortfolioValue = 0;
            let totalCostBasis = 0;
            Object.keys(gameState.player.stocks).forEach(symbol => {
                const holding = gameState.player.stocks[symbol];
                const stock = gameState.stockMarket.stocks[symbol];
                totalPortfolioValue += holding.shares * stock.price;
                totalCostBasis += holding.shares * holding.avgPrice;
            });

            const portfolioGrowth = totalCostBasis > 0 ? ((totalPortfolioValue - totalCostBasis) / totalCostBasis * 100).toFixed(2) : 0;
            elements.stockPortfolioGrowth.innerHTML = `<i class="fas ${portfolioGrowth >= 0 ? 'fa-arrow-up' : 'fa-arrow-down'}"></i> ${portfolioGrowth >= 0 ? '+' : ''}${portfolioGrowth}%`;
            elements.stockPortfolioGrowth.className = `widget-growth ${portfolioGrowth >= 0 ? 'positive' : 'negative'}`;
        }

        // NEW: Update trading hub
        function updateTradingHub() {
            let html = '';

            if (gameState.tradingHub.activeTrades.length === 0) {
                html = '<div class="widget" style="text-align: center; padding: 40px;"><i class="fas fa-exchange-alt" style="font-size: 60px; margin-bottom: 20px; opacity: 0.3;"></i><h3>No Active Trades</h3><p>Create trade offers or wait for other players to list assets!</p></div>';
            } else {
                gameState.tradingHub.activeTrades.forEach(trade => {
                    const canAfford = gameState.player.cash >= trade.price;
                    const isOwnTrade = trade.sellerId === gameState.player.id;

                    html += `
                        <div class="trade-card">
                            <div class="trader-info">
                                <div class="trader-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div>
                                    <div style="font-weight: 600;">${trade.sellerName}</div>
                                    <div style="font-size: 12px; opacity: 0.7;">Listed ${formatTimeAgo(trade.createdAt)}</div>
                                </div>
                            </div>
                            
                            <div style="text-align: center; margin: 15px 0;">
                                <div style="font-size: 40px; margin-bottom: 10px;">${trade.assetIcon}</div>
                                <h3 style="font-size: 18px; margin-bottom: 5px;">${trade.assetName}</h3>
                                <div style="font-size: 24px; font-weight: 700; color: var(--primary);">$${formatCurrency(trade.price)}</div>
                            </div>
                            
                            <p style="font-size: 14px; opacity: 0.8; margin-bottom: 15px;">${trade.description}</p>
                            
                            <div style="display: flex; gap: 10px;">
                                ${isOwnTrade 
                                    ? `<button class="btn btn-danger" onclick="cancelTrade('${trade.id}')" style="flex: 1;">
                                         <i class="fas fa-times"></i> Cancel
                                       </button>`
                                    : `<button class="btn btn-primary" onclick="executeTrade('${trade.id}')" ${!canAfford ? 'disabled' : ''} style="flex: 1;">
                                         <i class="fas fa-shopping-cart"></i> Buy
                                       </button>`
                                }
                                <button class="btn btn-outline" onclick="showAssetDetails('${trade.assetId}')" style="padding: 12px;">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }

            elements.tradeGrid.innerHTML = html;
        }

        // NEW: Update business empire
        function updateBusinessEmpire() {
            let html = '';

            if (gameState.player.businesses.length === 0) {
                html = '<div class="widget" style="text-align: center; padding: 40px;"><i class="fas fa-building" style="font-size: 60px; margin-bottom: 20px; opacity: 0.3;"></i><h3>No Businesses</h3><p>Start your business empire and generate passive income!</p></div>';
            } else {
                gameState.player.businesses.forEach(business => {
                    const businessType = gameState.businessTypes.find(bt => bt.id === business.type);
                    if (!businessType) return;

                    const currentIncome = businessType.baseIncome * Math.pow(1.5, business.level - 1);
                    const upgradeCost = businessType.basePrice * Math.pow(1.5, business.level);
                    const canUpgrade = gameState.player.cash >= upgradeCost && business.level < businessType.maxLevel;

                    html += `
                        <div class="business-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div style="font-size: 32px;">${businessType.icon}</div>
                                <div class="business-level">Level ${business.level}</div>
                            </div>
                            
                            <h3 style="font-size: 18px; margin-bottom: 10px;">${businessType.name}</h3>
                            <p style="font-size: 12px; opacity: 0.7; margin-bottom: 15px;">${businessType.description}</p>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; font-size: 14px;">
                                <div>
                                    <i class="fas fa-dollar-sign" style="color: var(--success); margin-right: 5px;"></i>
                                    $${formatCurrency(currentIncome)}/hr
                                </div>
                                <div>
                                    <i class="fas fa-users" style="color: var(--info); margin-right: 5px;"></i>
                                    ${business.employees} employees
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" onclick="upgradeBusiness('${business.id}')" ${!canUpgrade ? 'disabled' : ''} style="width: 100%;">
                                <i class="fas fa-arrow-up"></i> 
                                ${business.level >= businessType.maxLevel ? 'Max Level' : `Upgrade ($${formatCurrency(upgradeCost)})`}
                            </button>
                        </div>
                    `;
                });
            }

            elements.businessGrid.innerHTML = html;
        }

        // NEW: Update quests section
        function updateQuestsSection() {
            // Update daily bonus display
            const streak = gameState.player.quests.daily.loginStreak;
            elements.currentStreak.textContent = streak;

            // Update daily reward boxes
            document.querySelectorAll('.daily-reward').forEach((reward, index) => {
                const day = index + 1;
                reward.classList.remove('claimed', 'current', 'available');
                
                if (day < streak) {
                    reward.classList.add('claimed');
                } else if (day === streak && !gameState.player.quests.daily.bonusClaimed) {
                    reward.classList.add('current');
                } else if (day === streak + 1) {
                    reward.classList.add('available');
                }
            });

            // Update daily bonus button
            elements.claimDailyBtn.disabled = gameState.player.quests.daily.bonusClaimed;
            elements.claimDailyBtn.innerHTML = gameState.player.quests.daily.bonusClaimed 
                ? '<i class="fas fa-check"></i> Claimed Today'
                : '<i class="fas fa-gift"></i> Claim Daily Bonus';

            // Update active quests
            let questHTML = '';
            gameState.player.quests.active.forEach(quest => {
                const progress = Math.min((quest.progress / quest.target) * 100, 100);
                const isCompleted = quest.completed;
                const isClaimed = quest.claimed;

                questHTML += `
                    <div class="quest-item ${isCompleted ? 'completed' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="font-size: 16px; font-weight: 600;">${quest.name}</h3>
                            <div style="font-size: 14px; color: var(--warning);">
                                <i class="fas fa-coins"></i> $${formatCurrency(quest.reward)}
                            </div>
                        </div>
                        
                        <p style="font-size: 14px; opacity: 0.8; margin-bottom: 10px;">${quest.description}</p>
                        
                        <div class="quest-progress">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px;">
                                <span>Progress: ${formatCurrency(quest.progress)} / ${formatCurrency(quest.target)}</span>
                                <span>${progress.toFixed(1)}%</span>
                            </div>
                            <div class="quest-progress-bar">
                                <div class="quest-progress-fill" style="width: ${progress}%;"></div>
                            </div>
                        </div>
                        
                        ${isCompleted && !isClaimed 
                            ? `<button class="btn btn-success" onclick="claimQuestReward('${quest.id}')" style="width: 100%; margin-top: 15px;">
                                 <i class="fas fa-gift"></i> Claim Reward
                               </button>`
                            : isClaimed 
                                ? `<div style="text-align: center; margin-top: 15px; color: var(--success);">
                                     <i class="fas fa-check-circle"></i> Reward Claimed
                                   </div>`
                                : ''
                        }
                    </div>
                `;
            });

            elements.questList.innerHTML = questHTML;
        }

        // NEW: Update insurance section
        function updateInsuranceSection() {
            // Update risk assessment
            const portfolioValue = gameState.player.netWorth - gameState.player.cash;
            const debtRatio = gameState.player.stats.loanDebt / Math.max(gameState.player.netWorth, 1);
            const assetConcentration = gameState.player.assets.length > 0 ? 1 / gameState.player.assets.length : 1;

            const marketRisk = Math.min(25 + (portfolioValue / 100000) * 5, 50);
            const liquidityRisk = Math.min(15 + (assetConcentration * 20), 35);
            const creditRisk = Math.min(10 + (debtRatio * 30), 40);

            const overallRisk = (marketRisk + liquidityRisk + creditRisk) / 3;
            let riskLevel = "LOW";
            if (overallRisk > 30) riskLevel = "HIGH";
            else if (overallRisk > 20) riskLevel = "MEDIUM";

            elements.riskScore.textContent = riskLevel;
            elements.marketRisk.textContent = `${marketRisk.toFixed(0)}%`;
            elements.liquidityRisk.textContent = `${liquidityRisk.toFixed(0)}%`;
            elements.creditRisk.textContent = `${creditRisk.toFixed(0)}%`;
            elements.marketRiskBar.style.width = `${marketRisk}%`;
            elements.liquidityRiskBar.style.width = `${liquidityRisk}%`;
            elements.creditRiskBar.style.width = `${creditRisk}%`;

            // Update insurance policies display
            let insuranceHTML = '';
            gameState.insuranceTypes.forEach(insurance => {
                const hasPolicy = gameState.player.insurance.some(p => p.id === insurance.id);
                const activePolicy = gameState.player.insurance.find(p => p.id === insurance.id);

                insuranceHTML += `
                    <div class="insurance-card">
                        <h3 style="font-size: 18px; margin-bottom: 10px;">${insurance.name}</h3>
                        <p style="font-size: 14px; opacity: 0.8; margin-bottom: 15px;">${insurance.description}</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; font-size: 14px;">
                            <div>
                                <i class="fas fa-shield-alt" style="color: var(--primary); margin-right: 5px;"></i>
                                ${(insurance.coverage * 100).toFixed(0)}% Coverage
                            </div>
                            <div>
                                <i class="fas fa-dollar-sign" style="color: var(--warning); margin-right: 5px;"></i>
                                $${formatCurrency(insurance.cost)}
                            </div>
                        </div>
                        
                        ${hasPolicy 
                            ? `<div style="text-align: center; padding: 10px; background: rgba(40, 167, 69, 0.2); border-radius: 8px; border: 1px solid var(--success);">
                                 <i class="fas fa-check-circle" style="color: var(--success);"></i>
                                 <div style="font-size: 12px; margin-top: 5px;">
                                   Active (${formatTime(activePolicy.timeRemaining)} remaining)
                                 </div>
                               </div>`
                            : `<button class="btn btn-primary" onclick="buyInsurance('${insurance.id}')" style="width: 100%;">
                                 <i class="fas fa-shopping-cart"></i> Purchase Policy
                               </button>`
                        }
                    </div>
                `;
            });

            elements.insuranceGrid.innerHTML = insuranceHTML;
        }

        // Enhanced leaderboard with level display
        function updateLeaderboard() {
            // Re-sort leaderboard
            gameState.leaderboard.sort((a, b) => b.netWorth - a.netWorth);

            let html = '';
            gameState.leaderboard.slice(0, 25).forEach((player, index) => {
                const isCurrentPlayer = player.id === gameState.player.id;
                const rowClass = isCurrentPlayer ? 'player-you' : '';
                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : '';
                
                // Determine player level based on net worth
                const playerLevel = gameState.levels.reduce((level, l) => {
                    return player.netWorth >= l.requirement ? l.level : level;
                }, 1);

                html += `
                <tr class="${rowClass} ${rankClass}">
                    <td>
                        <span class="rank-badge">${index + 1}</span>
                    </td>
                    <td>
                        ${player.name} ${isCurrentPlayer ? '<span class="badge">You</span>' : ''}
                        <div style="font-size: 12px; opacity: 0.7;">Level ${playerLevel}</div>
                    </td>
                    <td style="text-align: center;">
                        <div style="display: inline-block; background: linear-gradient(135deg, var(--gold), var(--warning)); padding: 4px 8px; border-radius: 12px; color: var(--darkest); font-weight: 700; font-size: 12px;">
                            ${playerLevel}
                        </div>
                    </td>
                    <td style="text-align: right; font-weight: 600;">$${formatCurrency(player.netWorth)}</td>
                    <td style="text-align: right; font-weight: 600;" class="${player.roi >= 0 ? 'positive-roi' : 'negative-roi'}">
                        ${player.roi.toFixed(2)}%
                    </td>
                    <td style="text-align: right; font-weight: 600;">${player.assets}</td>
                </tr>
                `;
            });

            elements.leaderboardTable.innerHTML = html;
        }

        // Update research lab
        function updateResearchLab() {
            let html = '';
            let lockedAssets = gameState.market.assets.filter(asset => !asset.unlocked);

            if (lockedAssets.length === 0) {
                html = '<div class="widget" style="text-align: center; padding: 40px;"><i class="fas fa-trophy" style="font-size: 60px; margin-bottom: 20px; color: var(--gold);"></i><h3>Research Complete</h3><p>Congratulations! All premium assets have been unlocked.<br>Your research mastery has opened every investment opportunity.</p></div>';
            } else {
                lockedAssets.forEach(asset => {
                    const canUnlock = gameState.player.stats.researchPoints >= 5;

                    html += `
                    <div class="asset-card fade-in" data-id="${asset.id}">
                        <div class="asset-image" style="filter: grayscale(100%) opacity(0.6);">
                            ${asset.image}
                        </div>
                        <div class="asset-details">
                            <span class="asset-category" style="background: rgba(255, 193, 7, 0.15); color: var(--warning);">PREMIUM</span>
                            <h3 class="asset-name">${asset.name}</h3>
                            
                            <div class="asset-stats">
                                <div class="asset-stat">
                                    <div class="stat-label">ROI</div>
                                    <div class="stat-value">${((asset.reward / asset.price) * 100).toFixed(2)}%</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="stat-label">Research Cost</div>
                                    <div class="stat-value">5 points</div>
                                </div>
                            </div>
                            
                            <div class="asset-price">$${formatCurrency(asset.price)}</div>
                            
                            <div class="asset-actions">
                                <button class="btn ${canUnlock ? 'btn-primary' : 'btn-outline'} btn-asset unlock-btn" ${!canUnlock ? 'disabled' : ''}>
                                    <i class="fas fa-flask"></i> ${canUnlock ? 'Unlock' : 'Need 5 Points'}
                                </button>
                                <button class="btn btn-outline btn-asset info-btn">
                                    <i class="fas fa-info-circle"></i> Preview
                                </button>
                            </div>
                        </div>
                    </div>
                    `;
                });
            }

            elements.researchAssets.innerHTML = html;

            // Add event listeners to unlock buttons
            document.querySelectorAll('.unlock-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const assetId = this.closest('.asset-card').dataset.id;
                    unlockAsset(assetId);
                });
            });
            
            // Add event listeners to info buttons
            document.querySelectorAll('.info-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const assetId = this.closest('.asset-card').dataset.id;
                    showAssetDetails(assetId);
                });
            });
        }

        // Unlock an asset through research
        function unlockAsset(assetId) {
            const asset = gameState.market.assets.find(a => a.id === assetId);

            if (!asset || asset.unlocked) return;

            if (gameState.player.stats.researchPoints >= 5) {
                gameState.player.stats.researchPoints -= 5;
                asset.unlocked = true;

                updateUI();
                saveGame();
                showNotification("Premium Asset Unlocked", `${asset.name} is now available in the marketplace! This premium asset offers superior returns.`);
            } else {
                showNotification("Insufficient Points", "You need 5 research points to unlock this premium asset.", "error");
            }
        }

        // Rest of the functions remain the same but with enhanced formatting...
        
        // Format currency for large numbers
        function formatCurrency(amount) {
            if (amount >= 1000000000) {
                return (amount / 1000000000).toFixed(2) + "B";
            } else if (amount >= 1000000) {
                return (amount / 1000000).toFixed(2) + "M";
            } else if (amount >= 1000) {
                return (amount / 1000).toFixed(1) + "K";
            } else {
                return amount.toFixed(2);
            }
        }

        // Format time in seconds to HH:MM:SS
        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);

            return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // NEW: Format time ago
        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (days > 0) return `${days}d ago`;
            if (hours > 0) return `${hours}h ago`;
            if (minutes > 0) return `${minutes}m ago`;
            return 'Just now';
        }

        // Function to switch sections programmatically
        function switchToSection(sectionName) {
            activeSection = sectionName;
            updateUI();
        }

        // Update player's entry in leaderboard
        function updateLeaderboardEntry() {
            const playerEntry = gameState.leaderboard.find(p => p.id === gameState.player.id);
            if (playerEntry) {
                playerEntry.name = gameState.player.name;
                playerEntry.netWorth = gameState.player.netWorth;
                playerEntry.roi = gameState.player.stats.roi;
                playerEntry.assets = gameState.player.assets.length;
            }
            
            // Re-sort leaderboard
            gameState.leaderboard.sort((a, b) => b.netWorth - a.netWorth);
        }
        
        // Collect rewards from assets
        function collectRewards() {
            let totalReward = 0;
            
            gameState.market.assets.forEach(asset => {
                if (asset.owned) {
                    totalReward += asset.reward;
                }
            });
            
            if (totalReward > 0) {
                gameState.player.cash += totalReward;
                gameState.player.stats.lifetimeEarnings += totalReward;
                
                if (gameState.player.settings.rewardNotifications) {
                    showNotification("Rewards Collected", `You collected $${formatCurrency(totalReward)} from your assets!`);
                }
                
                updateNetWorth();
            }
        }

        // Check for random market events
        function checkMarketEvents(deltaTime) {
            if (!gameState.market.activeEvent && Math.random() < 0.0003 * deltaTime) {
                // Reduced probability for better gameplay
                const possibleEvents = gameState.market.events.filter(e => 
                    Math.random() < e.probability
                );

                if (possibleEvents.length > 0) {
                    const randomEvent = possibleEvents[Math.floor(Math.random() * possibleEvents.length)];
                    startMarketEvent(randomEvent);
                }
            }
        }

        // Start a market event
        function startMarketEvent(event) {
            gameState.market.activeEvent = event;
            gameState.market.eventTimer = event.duration;

            // Apply event effect to relevant assets
            gameState.market.assets.forEach(asset => {
                if (!event.category || asset.category === event.category) {
                    asset.price *= event.effect;
                }
            });

            if (gameState.player.settings.marketEventNotifications) {
                showNotification("Market Event", `${event.name}: ${event.description}`);
            }

            updateNetWorth();
        }

        // End the current market event
        function endMarketEvent() {
            const event = gameState.market.activeEvent;

            // Revert event effect
            gameState.market.assets.forEach(asset => {
                if (!event.category || asset.category === event.category) {
                    asset.price /= event.effect;
                }
            });

            gameState.market.activeEvent = null;

            if (gameState.player.settings.marketEventNotifications) {
                showNotification("Market Event Ended", `${event.name} has concluded. Prices returning to normal.`);
            }

            updateNetWorth();
        }

        // Generate enhanced leaderboard data
        function generateLeaderboard() {
            gameState.leaderboard = [];

            // Add player to leaderboard
            gameState.leaderboard.push({
                id: gameState.player.id,
                name: gameState.player.name,
                netWorth: gameState.player.netWorth,
                roi: gameState.player.stats.roi,
                assets: gameState.player.assets.length
            });

            // Generate fake players with realistic names and varied progress
            const investorNames = [
                "Warren Buffet Jr", "Catherine Wood", "Ray Dalio II", "Peter Lynch",
                "Benjamin Graham", "John Bogle", "Carl Icahn", "George Soros",
                "Bill Ackman", "David Einhorn", "Seth Klarman", "Joel Greenblatt",
                "Michael Burry", "Charlie Munger", "Mario Gabelli", "Ron Baron",
                "Thomas Rowe", "John Neff", "Peter Thiel", "Mark Cuban",
                "Elon Musk Jr", "Jeff Bezos II", "Satoshi Nakamoto", "Jack Bogle",
                "Howard Marks"
            ];

            for (let i = 0; i < 24; i++) {
                const baseNetWorth = 5000 + Math.random() * 10000000;
                const netWorth = Math.floor(baseNetWorth);
                const roi = -50 + Math.random() * 200;
                const assetCount = 1 + Math.floor(Math.random() * 20);

                gameState.leaderboard.push({
                    id: "bot_" + Math.random().toString(36).substr(2, 8),
                    name: investorNames[i] || `Elite Investor ${i + 1}`,
                    netWorth: netWorth,
                    roi: roi,
                    assets: assetCount
                });
            }

            // Sort leaderboard by net worth
            gameState.leaderboard.sort((a, b) => b.netWorth - a.netWorth);
        }

        // Update badges with enhanced achievements
        function updateBadges() {
            elements.badgesContainer.innerHTML = "";
            
            gameState.player.stats.badges.forEach(badge => {
                const badgeEl = document.createElement('span');
                badgeEl.className = 'badge';
                badgeEl.textContent = badge;
                elements.badgesContainer.appendChild(badgeEl);
            });
            
            // Enhanced achievement system
            const achievements = [
                { condition: () => gameState.player.netWorth >= 100000, badge: "Millionaire", message: "Millionaire status achieved!" },
                { condition: () => gameState.player.netWorth >= 1000000, badge: "Multi-Millionaire", message: "Multi-Millionaire status achieved!" },
                { condition: () => gameState.player.netWorth >= 10000000, badge: "Billionaire", message: "Congratulations! You're now a Billionaire!" },
                { condition: () => gameState.player.assets.length >= 5, badge: "Diversified", message: "Diversified portfolio achieved!" },
                { condition: () => gameState.player.assets.length >= 10, badge: "Asset Mogul", message: "Asset empire established!" },
                { condition: () => gameState.player.assets.length >= 20, badge: "Investment King", message: "Investment royalty achieved!" },
                { condition: () => gameState.player.stats.researchPoints >= 20, badge: "Research Expert", message: "Research mastery unlocked! 2x research speed." },
                { condition: () => gameState.player.stats.lifetimeEarnings >= 100000, badge: "High Earner", message: "High earner status achieved!" },
                { condition: () => gameState.player.stats.lifetimeEarnings >= 1000000, badge: "Wealth Generator", message: "Wealth generation mastery!" },
                { condition: () => gameState.player.stats.roi >= 50, badge: "ROI Master", message: "ROI mastery achieved!" },
                { condition: () => gameState.player.stats.roi >= 100, badge: "Profit Genius", message: "Exceptional profit generation!" },
                { condition: () => gameState.player.level >= 5, badge: "Level Elite", message: "Elite investor level reached!" },
                { condition: () => gameState.player.level >= 10, badge: "Maximum Level", message: "Maximum level achieved! You are legendary!" },
                { condition: () => gameState.player.salaryCount >= 10, badge: "Salary Pro", message: "Salary collection expertise!" },
                { condition: () => gameState.player.stats.loanRepaymentHistory.length >= 5, badge: "Debt Manager", message: "Excellent debt management!" },
                // NEW: Trading and business achievements
                { condition: () => gameState.player.tradingStats.successfulTrades >= 10, badge: "Trading Expert", message: "Master trader status achieved!" },
                { condition: () => gameState.player.businesses.length >= 5, badge: "Business Mogul", message: "Business empire established!" },
                { condition: () => Object.keys(gameState.player.stocks).length >= 5, badge: "Stock Investor", message: "Diversified stock portfolio!" },
                { condition: () => gameState.player.quests.daily.loginStreak >= 7, badge: "Dedicated Investor", message: "Week-long dedication rewarded!" },
                { condition: () => gameState.player.insurance.length > 0, badge: "Risk Manager", message: "Smart risk management!" }
            ];

            achievements.forEach(achievement => {
                if (achievement.condition() && !gameState.player.stats.badges.includes(achievement.badge)) {
                    gameState.player.stats.badges.push(achievement.badge);
                    showNotification("Achievement Unlocked", achievement.message);
                }
            });
        }

        // Update the currently visible section
        function updateCurrentSection() {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });

            // Show active section
            const activeElement = document.getElementById(`${activeSection}-section`);
            if (activeElement) {
                activeElement.style.display = 'block';
            }

            // Update sidebar active item
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.classList.remove('active');
            });
            const activeLink = document.querySelector(`.sidebar-menu a[data-section="${activeSection}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }

            // Update section-specific content
            switch (activeSection) {
                case 'marketplace':
                    updateMarketplace();
                    break;
                case 'portfolio':
                    updatePortfolio();
                    break;
                case 'stocks':
                    updateStockMarket();
                    break;
                case 'trading':
                    updateTradingHub();
                    break;
                case 'business':
                    updateBusinessEmpire();
                    break;
                case 'quests':
                    updateQuestsSection();
                    break;
                case 'insurance':
                    updateInsuranceSection();
                    break;
                case 'leaderboard':
                    updateLeaderboard();
                    break;
                case 'research':
                    updateResearchLab();
                    break;
                case 'loans':
                    updateLoanCenter();
                    break;
            }
        }

        // Show enhanced asset details modal
        function showAssetDetails(assetId) {
            const asset = gameState.market.assets.find(a => a.id === assetId);
            if (!asset) return;
            
            elements.modalAssetIcon.innerHTML = asset.image;
            elements.modalAssetName.textContent = asset.name;
            elements.modalAssetCategory.textContent = asset.category.replace('-', ' ');
            elements.modalAssetPrice.textContent = `$${formatCurrency(asset.price)}`;
            elements.modalAssetReward.textContent = `$${formatCurrency(asset.reward)}/30min`;
            elements.modalAssetROI.textContent = `${((asset.reward / asset.price) * 100).toFixed(2)}%`;
            elements.modalAssetGrowth.textContent = `${(asset.appreciationRate * 3600 * 100).toFixed(2)}%/hr`;
            elements.modalAssetDescription.textContent = asset.description;
            
            // Set up action buttons
            elements.modalAssetActions.innerHTML = '';
            if (asset.owned) {
                const sellBtn = document.createElement('button');
                sellBtn.className = 'btn btn-danger';
                sellBtn.innerHTML = '<i class="fas fa-dollar-sign"></i> Sell Asset';
                sellBtn.addEventListener('click', () => {
                    sellAsset(asset.id);
                    elements.assetModal.style.display = 'none';
                });
                elements.modalAssetActions.appendChild(sellBtn);
                
                const closeBtn = document.createElement('button');
                closeBtn.className = 'btn btn-outline';
                closeBtn.innerHTML = '<i class="fas fa-times"></i> Close';
                closeBtn.addEventListener('click', () => {
                    elements.assetModal.style.display = 'none';
                });
                elements.modalAssetActions.appendChild(closeBtn);
            } else if (asset.unlocked) {
                const buyBtn = document.createElement('button');
                buyBtn.className = 'btn btn-primary';
                buyBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Purchase Asset';
                buyBtn.disabled = gameState.player.cash < asset.price;
                buyBtn.addEventListener('click', () => {
                    buyAsset(asset.id);
                    elements.assetModal.style.display = 'none';
                });
                elements.modalAssetActions.appendChild(buyBtn);
                
                const closeBtn = document.createElement('button');
                closeBtn.className = 'btn btn-outline';
                closeBtn.innerHTML = '<i class="fas fa-times"></i> Close';
                closeBtn.addEventListener('click', () => {
                    elements.assetModal.style.display = 'none';
                });
                elements.modalAssetActions.appendChild(closeBtn);
            } else {
                const unlockBtn = document.createElement('button');
                unlockBtn.className = 'btn btn-primary';
                unlockBtn.innerHTML = '<i class="fas fa-flask"></i> Unlock with Research';
                unlockBtn.disabled = gameState.player.stats.researchPoints < 5;
                unlockBtn.addEventListener('click', () => {
                    unlockAsset(asset.id);
                    elements.assetModal.style.display = 'none';
                });
                elements.modalAssetActions.appendChild(unlockBtn);
                
                const closeBtn = document.createElement('button');
                closeBtn.className = 'btn btn-outline';
                closeBtn.innerHTML = '<i class="fas fa-times"></i> Close';
                closeBtn.addEventListener('click', () => {
                    elements.assetModal.style.display = 'none';
                });
                elements.modalAssetActions.appendChild(closeBtn);
            }
            
            elements.assetModal.style.display = 'flex';
        }

        // Enhanced notification system
        function showNotification(title, message, type = "success") {
            // Check settings for notification types
            if ((type === "success" && !gameState.player.settings.rewardNotifications)) {
                return;
            }

            elements.notificationTitle.textContent = title;
            elements.notificationMessage.textContent = message;

            // Set notification type
            elements.notificationToast.className = "notification-toast";
            elements.notificationToast.classList.add(`notification-${type}`);
            elements.notificationToast.classList.add("show");

            // Update icon based on type
            const iconElement = elements.notificationToast.querySelector('.notification-icon i');
            switch (type) {
                case 'success':
                    iconElement.className = 'fas fa-check-circle';
                    break;
                case 'warning':
                    iconElement.className = 'fas fa-exclamation-triangle';
                    break;
                case 'error':
                    iconElement.className = 'fas fa-times-circle';
                    break;
                default:
                    iconElement.className = 'fas fa-info-circle';
            }

            // Auto-hide after 6 seconds
            setTimeout(() => {
                elements.notificationToast.classList.remove("show");
            }, 6000);
        }

        // Enhanced event listeners setup with ALL NEW FEATURES
        function setupEventListeners() {
            // Sidebar navigation
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    activeSection = this.dataset.section;
                    updateUI();
                });
            });

            // Marketplace filters
            elements.categoryFilter.addEventListener('change', updateMarketplace);
            elements.sortFilter.addEventListener('change', updateMarketplace);
            elements.assetSearch.addEventListener('input', updateMarketplace);

            // Loan buttons
            elements.loanBtn.addEventListener('click', function() {
                elements.loanModal.style.display = 'flex';
            });

            elements.newLoanBtn.addEventListener('click', function() {
                elements.loanModal.style.display = 'flex';
            });
            
            // Loan option selection
            document.querySelectorAll('.loan-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.loan-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedLoanOption = {
                        amount: parseFloat(this.dataset.amount),
                        interest: parseFloat(this.dataset.interest)
                    };
                    elements.confirmLoanBtn.disabled = false;
                });
            });
            
            // Confirm loan
            elements.confirmLoanBtn.addEventListener('click', function() {
                if (selectedLoanOption) {
                    const loanAmount = selectedLoanOption.amount;
                    const interest = selectedLoanOption.interest;
                    
                    gameState.player.cash += loanAmount;
                    gameState.player.stats.loanDebt += loanAmount * (1 + interest/100);
                    gameState.player.stats.loanInterest = interest;
                    
                    elements.loanModal.style.display = 'none';
                    selectedLoanOption = null;
                    elements.confirmLoanBtn.disabled = true;
                    document.querySelectorAll('.loan-option').forEach(o => o.classList.remove('selected'));
                    
                    updateNetWorth();
                    updateUI();
                    saveGame();
                    
                    showNotification("Loan Approved", `You've received $${formatCurrency(loanAmount)} at ${interest}% annual interest. Invest wisely!`);
                }
            });
            
            // Cancel loan
            elements.cancelLoanBtn.addEventListener('click', function() {
                elements.loanModal.style.display = 'none';
                selectedLoanOption = null;
                elements.confirmLoanBtn.disabled = true;
                document.querySelectorAll('.loan-option').forEach(o => o.classList.remove('selected'));
            });
            
            elements.closeLoanModal.addEventListener('click', function() {
                elements.loanModal.style.display = 'none';
                selectedLoanOption = null;
                elements.confirmLoanBtn.disabled = true;
                document.querySelectorAll('.loan-option').forEach(o => o.classList.remove('selected'));
            });

            // Loan repayment functionality
            elements.repayLoanBtn.addEventListener('click', repayLoan);

            // Quick amount buttons for loan repayment
            document.querySelectorAll('.quick-amount-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const percentage = parseFloat(this.dataset.percentage);
                    const repaymentAmount = (gameState.player.stats.loanDebt * percentage / 100).toFixed(2);
                    elements.repaymentAmount.value = repaymentAmount;
                });
            });

            // Portfolio action buttons
            elements.sellAllBtn.addEventListener('click', function() {
                if (gameState.player.assets.length === 0) {
                    showNotification("No Assets", "You don't have any assets to sell.", "error");
                    return;
                }

                if (confirm("Are you sure you want to liquidate all your assets? You'll receive 95% of their current value.")) {
                    let totalSaleValue = 0;
                    gameState.market.assets.forEach(asset => {
                        if (asset.owned) {
                            totalSaleValue += asset.price * 0.95;
                            asset.owned = false;
                        }
                    });

                    gameState.player.cash += totalSaleValue;
                    gameState.player.assets = [];
                    updateNetWorth();
                    updateUI();
                    saveGame();

                    showNotification("Portfolio Liquidated", `All assets sold for $${formatCurrency(totalSaleValue)} (5% fees deducted)`);
                }
            });
            
            elements.collectAllBtn.addEventListener('click', function() {
                collectRewards();
                gameState.player.rewardTimer = 30 * 60; // Reset timer
                saveGame();
            });

            // NEW: Stock market event listeners
            elements.buyStockBtn.addEventListener('click', function() {
                elements.stockModal.style.display = 'flex';
                updateStockModal();
            });

            elements.refreshStocks.addEventListener('click', function() {
                updateStockMarket();
                showNotification("Stocks Refreshed", "Latest market data loaded");
            });

            elements.stockSymbolSelect.addEventListener('change', updateStockModal);
            elements.shareQuantity.addEventListener('input', updateStockModal);

            elements.confirmStockBtn.addEventListener('click', function() {
                const symbol = elements.stockSymbolSelect.value;
                const shares = parseInt(elements.shareQuantity.value);
                
                if (shares > 0) {
                    buyStocks(symbol, shares);
                    elements.stockModal.style.display = 'none';
                    elements.shareQuantity.value = '';
                }
            });

            elements.cancelStockBtn.addEventListener('click', function() {
                elements.stockModal.style.display = 'none';
                elements.shareQuantity.value = '';
            });

            elements.closeStockModal.addEventListener('click', function() {
                elements.stockModal.style.display = 'none';
                elements.shareQuantity.value = '';
            });

            // NEW: Trading event listeners
            elements.createTradeBtn.addEventListener('click', function() {
                // Update trade asset select with owned assets
                elements.tradeAssetSelect.innerHTML = '<option value="">Select an asset...</option>';
                gameState.market.assets.forEach(asset => {
                    if (asset.owned) {
                        const option = document.createElement('option');
                        option.value = asset.id;
                        option.textContent = `${asset.name} - $${formatCurrency(asset.price)}`;
                        elements.tradeAssetSelect.appendChild(option);
                    }
                });
                
                if (gameState.player.assets.length === 0) {
                    showNotification("No Assets", "You need to own assets to create trades.", "error");
                    return;
                }
                
                elements.tradingModal.style.display = 'flex';
            });

            elements.confirmTradeBtn.addEventListener('click', function() {
                const assetId = elements.tradeAssetSelect.value;
                const price = parseFloat(elements.tradePrice.value);
                const description = elements.tradeDescription.value;

                if (assetId && price > 0 && description.trim()) {
                    createTrade(assetId, price, description);
                    elements.tradingModal.style.display = 'none';
                    elements.tradeAssetSelect.value = '';
                    elements.tradePrice.value = '';
                    elements.tradeDescription.value = '';
                }
            });

            elements.cancelTradeBtn.addEventListener('click', function() {
                elements.tradingModal.style.display = 'none';
                elements.tradeAssetSelect.value = '';
                elements.tradePrice.value = '';
                elements.tradeDescription.value = '';
            });

            elements.closeTradingModal.addEventListener('click', function() {
                elements.tradingModal.style.display = 'none';
                elements.tradeAssetSelect.value = '';
                elements.tradePrice.value = '';
                elements.tradeDescription.value = '';
            });

            // NEW: Business event listeners
            elements.createBusinessBtn.addEventListener('click', function() {
                // Populate business types
                elements.businessTypes.innerHTML = '';
                gameState.businessTypes.forEach(businessType => {
                    const canAfford = gameState.player.cash >= businessType.basePrice;
                    const div = document.createElement('div');
                    div.className = `business-option ${canAfford ? '' : 'disabled'}`;
                    div.style.cssText = `
                        display: flex; align-items: center; gap: 15px; padding: 15px;
                        border: 2px solid ${canAfford ? 'rgba(110, 69, 226, 0.3)' : 'rgba(255, 255, 255, 0.1)'};
                        border-radius: 12px; cursor: ${canAfford ? 'pointer' : 'not-allowed'};
                        transition: all 0.3s ease; margin-bottom: 10px;
                        opacity: ${canAfford ? '1' : '0.5'};
                    `;
                    
                    div.innerHTML = `
                        <div style="font-size: 32px;">${businessType.icon}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 5px;">${businessType.name}</div>
                            <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">${businessType.description}</div>
                            <div style="font-size: 14px; color: var(--warning);">$${formatCurrency(businessType.basePrice)} â€¢ $${formatCurrency(businessType.baseIncome)}/hr</div>
                        </div>
                    `;
                    
                    if (canAfford) {
                        div.addEventListener('click', function() {
                            document.querySelectorAll('.business-option').forEach(o => o.classList.remove('selected'));
                            this.classList.add('selected');
                            this.style.borderColor = 'var(--primary)';
                            selectedBusinessType = businessType.id;
                            elements.confirmBusinessBtn.disabled = false;
                        });
                    }
                    
                    elements.businessTypes.appendChild(div);
                });
                
                elements.businessModal.style.display = 'flex';
            });

            elements.confirmBusinessBtn.addEventListener('click', function() {
                if (selectedBusinessType) {
                    createBusiness(selectedBusinessType);
                    elements.businessModal.style.display = 'none';
                    selectedBusinessType = null;
                    elements.confirmBusinessBtn.disabled = true;
                }
            });

            elements.cancelBusinessBtn.addEventListener('click', function() {
                elements.businessModal.style.display = 'none';
                selectedBusinessType = null;
                elements.confirmBusinessBtn.disabled = true;
            });

            elements.closeBusinessModal.addEventListener('click', function() {
                elements.businessModal.style.display = 'none';
                selectedBusinessType = null;
                elements.confirmBusinessBtn.disabled = true;
            });

            // NEW: Quest event listeners
            elements.claimDailyBtn.addEventListener('click', claimDailyBonus);

            // NEW: Insurance event listeners
            elements.buyInsuranceBtn.addEventListener('click', function() {
                // Populate insurance policies
                elements.insurancePolicies.innerHTML = '';
                gameState.insuranceTypes.forEach(insurance => {
                    const hasPolicy = gameState.player.insurance.some(p => p.id === insurance.id);
                    const canAfford = gameState.player.cash >= insurance.cost && !hasPolicy;
                    
                    const div = document.createElement('div');
                    div.className = `insurance-option ${canAfford ? '' : 'disabled'}`;
                    div.style.cssText = `
                        display: flex; align-items: center; gap: 15px; padding: 15px;
                        border: 2px solid ${canAfford ? 'rgba(110, 69, 226, 0.3)' : 'rgba(255, 255, 255, 0.1)'};
                        border-radius: 12px; cursor: ${canAfford ? 'pointer' : 'not-allowed'};
                        transition: all 0.3s ease; margin-bottom: 10px;
                        opacity: ${canAfford ? '1' : '0.5'};
                    `;
                    
                    div.innerHTML = `
                        <div style="font-size: 32px;"><i class="fas fa-shield-alt"></i></div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 5px;">${insurance.name}</div>
                            <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">${insurance.description}</div>
                            <div style="font-size: 14px; color: var(--warning);">$${formatCurrency(insurance.cost)} â€¢ ${(insurance.coverage * 100)}% Coverage</div>
                        </div>
                        ${hasPolicy ? '<div style="color: var(--success);"><i class="fas fa-check-circle"></i> Active</div>' : ''}
                    `;
                    
                    if (canAfford) {
                        div.addEventListener('click', function() {
                            document.querySelectorAll('.insurance-option').forEach(o => o.classList.remove('selected'));
                            this.classList.add('selected');
                            this.style.borderColor = 'var(--primary)';
                            selectedInsuranceType = insurance.id;
                            elements.confirmInsuranceBtn.disabled = false;
                        });
                    }
                    
                    elements.insurancePolicies.appendChild(div);
                });
                
                elements.insuranceModal.style.display = 'flex';
            });

            elements.confirmInsuranceBtn.addEventListener('click', function() {
                if (selectedInsuranceType) {
                    buyInsurance(selectedInsuranceType);
                    elements.insuranceModal.style.display = 'none';
                    selectedInsuranceType = null;
                    elements.confirmInsuranceBtn.disabled = true;
                }
            });

            elements.cancelInsuranceBtn.addEventListener('click', function() {
                elements.insuranceModal.style.display = 'none';
                selectedInsuranceType = null;
                elements.confirmInsuranceBtn.disabled = true;
            });

            elements.closeInsuranceModal.addEventListener('click', function() {
                elements.insuranceModal.style.display = 'none';
                selectedInsuranceType = null;
                elements.confirmInsuranceBtn.disabled = true;
            });

            // Profile update
            elements.updateProfileBtn.addEventListener('click', function() {
                const newName = elements.playerNameInput.value.trim();
                if (newName && newName !== gameState.player.name) {
                    gameState.player.name = newName;
                    updateUI();
                    saveGame();
                    showNotification("Profile Updated", `Welcome, ${newName}! Your profile has been updated.`);
                }
            });

            // Research info
            elements.researchInfoBtn.addEventListener('click', function() {
                elements.researchInfoModal.style.display = 'flex';
            });

            elements.closeResearchInfoModal.addEventListener('click', function() {
                elements.researchInfoModal.style.display = 'none';
            });

            elements.closeResearchInfoBtn.addEventListener('click', function() {
                elements.researchInfoModal.style.display = 'none';
            });

            // Notification close
            elements.closeNotification.addEventListener('click', function() {
                elements.notificationToast.classList.remove("show");
            });
            
            // Modal close handlers
            elements.closeModal.addEventListener('click', function() {
                elements.assetModal.style.display = 'none';
            });
            
            window.addEventListener('click', function(e) {
                if (e.target === elements.assetModal) {
                    elements.assetModal.style.display = 'none';
                }
                if (e.target === elements.loanModal) {
                    elements.loanModal.style.display = 'none';
                }
                if (e.target === elements.tradingModal) {
                    elements.tradingModal.style.display = 'none';
                }
                if (e.target === elements.businessModal) {
                    elements.businessModal.style.display = 'none';
                }
                if (e.target === elements.stockModal) {
                    elements.stockModal.style.display = 'none';
                }
                if (e.target === elements.insuranceModal) {
                    elements.insuranceModal.style.display = 'none';
                }
                if (e.target === elements.researchInfoModal) {
                    elements.researchInfoModal.style.display = 'none';
                }
            });

            // Game data management
            elements.saveGameBtn.addEventListener('click', saveGame);
            elements.loadGameBtn.addEventListener('click', loadGame);
            elements.resetGameBtn.addEventListener('click', resetGame);
            
            // Settings
            elements.rewardNotifications.addEventListener('change', function() {
                gameState.player.settings.rewardNotifications = this.checked;
                saveGame();
            });
            
            elements.salaryNotifications.addEventListener('change', function() {
                gameState.player.settings.salaryNotifications = this.checked;
                saveGame();
            });
            
            elements.marketEventNotifications.addEventListener('change', function() {
                gameState.player.settings.marketEventNotifications = this.checked;
                saveGame();
            });
            
            // Refresh buttons
            elements.refreshMarket.addEventListener('click', function() {
                updateMarketplace();
                showNotification("Market Refreshed", "Latest asset data loaded");
            });
            
            elements.refreshLeaderboard.addEventListener('click', function() {
                // Simulate other players' activity
                gameState.leaderboard.forEach(player => {
                    if (player.id !== gameState.player.id) {
                        const change = (Math.random() * 10000 - 5000);
                        player.netWorth = Math.max(1000, player.netWorth + change);
                        player.roi = -50 + Math.random() * 200;
                    }
                });
                updateLeaderboard();
                showNotification("Rankings Updated", "Latest leaderboard data loaded");
            });
            
            elements.refreshDashboard.addEventListener('click', function() {
                updateUI();
                showNotification("Dashboard Refreshed", "All analytics updated");
            });
            
            // Auto-save on page unload
            window.addEventListener('beforeunload', saveGame);
        }

        // NEW: Update stock modal with real-time calculations
        function updateStockModal() {
            const symbol = elements.stockSymbolSelect.value;
            const shares = parseInt(elements.shareQuantity.value) || 0;
            const stock = gameState.stockMarket.stocks[symbol];
            
            if (stock && shares > 0) {
                const totalCost = stock.price * shares;
                const commission = totalCost * 0.02;
                const finalCost = totalCost + commission;
                
                elements.currentStockPrice.textContent = `$${stock.price.toFixed(2)}`;
                elements.totalStockCost.textContent = `$${formatCurrency(totalCost)}`;
                elements.stockCommission.textContent = `$${formatCurrency(commission)}`;
                
                elements.confirmStockBtn.disabled = gameState.player.cash < finalCost;
            } else {
                elements.currentStockPrice.textContent = '$0.00';
                elements.totalStockCost.textContent = '$0.00';
                elements.stockCommission.textContent = '$0.00';
                elements.confirmStockBtn.disabled = true;
            }
        }

        // NEW: Global functions for onclick handlers
        window.upgradeBusiness = upgradeBusiness;
        window.executeTrade = executeTrade;
        window.cancelTrade = function(tradeId) {
            const tradeIndex = gameState.tradingHub.activeTrades.findIndex(t => t.id === tradeId);
            if (tradeIndex > -1) {
                const trade = gameState.tradingHub.activeTrades[tradeIndex];
                
                // Return asset to seller
                const asset = gameState.market.assets.find(a => a.id === trade.assetId);
                asset.owned = true;
                gameState.player.assets.push(trade.assetId);
                
                // Remove from active trades
                gameState.tradingHub.activeTrades.splice(tradeIndex, 1);
                
                updateNetWorth();
                updateUI();
                saveGame();
                
                showNotification("Trade Cancelled", `Your ${trade.assetName} trade has been cancelled.`);
            }
        };
        window.sellStocks = sellStocks;
        window.claimQuestReward = claimQuestReward;
        window.buyInsurance = buyInsurance;

        // Enhanced save/load/reset functions
        function saveGame() {
            try {
                gameState.player.lastUpdate = Date.now();
                localStorage.setItem('assetMasterProEliteSave', JSON.stringify(gameState));
                showNotification("Game Saved", "Your progress has been securely saved.");
                console.log('Game saved successfully');
            } catch (error) {
                console.error('Failed to save game:', error);
                showNotification("Save Failed", "Could not save game data. Please try again.", "error");
            }
        }

        function loadGame() {
            try {
                const savedData = localStorage.getItem('assetMasterProEliteSave');
                if (savedData) {
                    const loadedState = JSON.parse(savedData);
                    
         // Merge with default data to handle new features
                    gameState = Object.assign({}, gameData, loadedState);
                    
                    // Ensure all required properties exist for new features
                    if (!gameState.player.stocks) {
                        gameState.player.stocks = {};
                    }
                    if (!gameState.player.businesses) {
                        gameState.player.businesses = [];
                    }
                    if (!gameState.player.tradingStats) {
                        gameState.player.tradingStats = {
                            totalTrades: 0,
                            successfulTrades: 0,
                            tradingProfit: 0,
                            reputation: 100
                        };
                    }
                    if (!gameState.player.quests) {
                        gameState.player.quests = {
                            daily: {
                                loginStreak: 1,
                                lastLogin: Date.now(),
                                bonusClaimed: false
                            },
                            active: []
                        };
                        generateQuests();
                    }
                    if (!gameState.player.insurance) {
                        gameState.player.insurance = [];
                    }
                    if (!gameState.stockMarket) {
                        gameState.stockMarket = gameData.stockMarket;
                        initializeStockMarket();
                    }
                    if (!gameState.tradingHub) {
                        gameState.tradingHub = {
                            activeTrades: [],
                            completedTrades: []
                        };
                    }
                    if (!gameState.player.stats.badges) {
                        gameState.player.stats.badges = ["New Investor"];
                    }
                    if (!gameState.player.netWorthHistory) {
                        gameState.player.netWorthHistory = Array(7).fill(gameState.player.netWorth);
                    }
                    if (!gameState.player.level) {
                        gameState.player.level = 1;
                    }
                    if (!gameState.player.salaryCount) {
                        gameState.player.salaryCount = 0;
                    }
                    if (!gameState.player.stats.loanRepaymentHistory) {
                        gameState.player.stats.loanRepaymentHistory = [];
                    }
                    
                    // Update research timer to new 10-minute system
                    if (gameState.player.stats.researchTimer > 10 * 60) {
                        gameState.player.stats.researchTimer = 10 * 60;
                    }
                    
                    // Update UI elements
                    elements.playerNameInput.value = gameState.player.name;
                    elements.rewardNotifications.checked = gameState.player.settings.rewardNotifications;
                    elements.salaryNotifications.checked = gameState.player.settings.salaryNotifications;
                    elements.marketEventNotifications.checked = gameState.player.settings.marketEventNotifications;
                    
                    updateUI();
                    showNotification("Game Loaded", "Your saved progress has been successfully loaded!");
                } else {
                    showNotification("No Save Found", "No saved game data was found.", "error");
                }
            } catch (error) {
                console.error('Failed to load game:', error);
                showNotification("Load Failed", "Could not load saved game data. The file may be corrupted.", "error");
            }
        }

        function resetGame() {
            if (confirm("âš ï¸ PERMANENT ACTION âš ï¸\n\nAre you absolutely sure you want to reset your game?\n\nThis will permanently delete:\nâ€¢ All your assets and progress\nâ€¢ Your current level and achievements\nâ€¢ All financial data and statistics\nâ€¢ Stock holdings and businesses\nâ€¢ Trading history and quests\n\nThis action cannot be undone!")) {
                localStorage.removeItem('assetMasterProEliteSave');
                gameState = JSON.parse(JSON.stringify(gameData));
                initializeStockMarket();
                generateQuests();
                generateLeaderboard();
                elements.playerNameInput.value = gameState.player.name;
                updateUI();
                showNotification("Game Reset Complete", "Your game has been reset to the beginning. Welcome back, new investor!");
            }
        }

        // Enhanced chart initialization with all new features
        function initCharts() {
            try {
                // Net worth chart with enhanced styling
                const netWorthCtx = document.getElementById('netWorthChart');
                if (netWorthCtx) {
                    netWorthChart = new Chart(netWorthCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: ['-6', '-5', '-4', '-3', '-2', '-1', 'Now'],
                            datasets: [{
                                label: 'Net Worth',
                                data: gameState.player.netWorthHistory,
                                borderColor: 'rgba(110, 69, 226, 1)',
                                backgroundColor: 'rgba(110, 69, 226, 0.1)',
                                borderWidth: 3,
                                tension: 0.4,
                                fill: true,
                                pointRadius: 0,
                                pointHoverRadius: 8,
                                pointHoverBackgroundColor: 'rgba(110, 69, 226, 1)',
                                pointHoverBorderColor: '#ffffff',
                                pointHoverBorderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                x: {
                                    display: true,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.05)',
                                        lineWidth: 1
                                    },
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.7)',
                                        font: {
                                            size: 11
                                        }
                                    }
                                },
                                y: {
                                    display: true,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.05)',
                                        lineWidth: 1
                                    },
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.7)',
                                        font: {
                                            size: 11
                                        },
                                        callback: function(value) {
                                            return '$' + formatCurrency(value);
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // Income chart with enhanced colors
                const incomeCtx = document.getElementById('incomeChart');
                if (incomeCtx) {
                    incomeChart = new Chart(incomeCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['Real Estate', 'Tech', 'Energy', 'Commodities', 'Infra', 'Vehicles'],
                            datasets: [{
                                label: 'Income',
                                data: [0, 0, 0, 0, 0, 0],
                                backgroundColor: [
                                    'rgba(110, 69, 226, 0.8)',
                                    'rgba(136, 211, 206, 0.8)',
                                    'rgba(255, 193, 7, 0.8)',
                                    'rgba(220, 53, 69, 0.8)',
                                    'rgba(23, 162, 184, 0.8)',
                                    'rgba(40, 167, 69, 0.8)'
                                ],
                                borderWidth: 0,
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.05)'
                                    },
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.7)',
                                        font: {
                                            size: 10
                                        }
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    },
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.7)',
                                        font: {
                                            size: 10
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // Enhanced asset distribution chart
                const assetDistCtx = document.getElementById('assetDistributionChart');
                if (assetDistCtx) {
                    assetDistChart = new Chart(assetDistCtx.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Real Estate', 'Technology', 'Energy', 'Commodities', 'Infrastructure', 'Vehicles'],
                            datasets: [{
                                data: [0, 0, 0, 0, 0, 0],
                                backgroundColor: [
                                    'rgba(110, 69, 226, 0.8)',
                                    'rgba(136, 211, 206, 0.8)',
                                    'rgba(255, 193, 7, 0.8)',
                                    'rgba(220, 53, 69, 0.8)',
                                    'rgba(23, 162, 184, 0.8)',
                                    'rgba(40, 167, 69, 0.8)'
                                ],
                                borderWidth: 3,
                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                hoverBorderWidth: 4,
                                hoverBorderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: {
                                        color: 'rgba(255, 255, 255, 0.8)',
                                        padding: 20,
                                        font: {
                                            size: 12
                                        },
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                    }
                                }
                            }
                        }
                    });
                }

                // NEW: Stock chart for market analysis
                const stockCtx = document.getElementById('stockChart');
                if (stockCtx) {
                    const selectedStock = gameState.stockMarket.stocks[elements.stockSelector.value] || gameState.stockMarket.stocks.AAPL;
                    
                    stockChart = new Chart(stockCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: Array.from({length: selectedStock.history.length}, (_, i) => `${i}h`),
                            datasets: [{
                                label: 'Stock Price',
                                data: selectedStock.history,
                                borderColor: 'rgba(136, 211, 206, 1)',
                                backgroundColor: 'rgba(136, 211, 206, 0.1)',
                                borderWidth: 2,
                                tension: 0.3,
                                fill: true,
                                pointRadius: 2,
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                x: {
                                    display: true,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.05)'
                                    },
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.7)',
                                        maxTicksLimit: 6
                                    }
                                },
                                y: {
                                    display: true,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.05)'
                                    },
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.7)',
                                        callback: function(value) {
                                            return '$' + value.toFixed(2);
                                        }
                                    }
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            }
                        }
                    });

                    // Update stock chart when selector changes
                    elements.stockSelector.addEventListener('change', function() {
                        const stock = gameState.stockMarket.stocks[this.value];
                        if (stock && stockChart) {
                            stockChart.data.datasets[0].data = stock.history;
                            stockChart.data.labels = Array.from({length: stock.history.length}, (_, i) => `${i}h`);
                            stockChart.update();
                        }
                    });
                }
                
                chartsInitialized = true;
                console.log('Enhanced charts with all features initialized successfully');
            } catch (error) {
                console.error('Failed to initialize charts:', error);
            }
        }
        
        // Enhanced chart updates with all new features
        function updateCharts() {
            if (!chartsInitialized) return;
            
            try {
                // Update net worth chart
                if (netWorthChart) {
                    netWorthChart.data.datasets[0].data = gameState.player.netWorthHistory;
                    netWorthChart.update('none');
                }
                
                // Calculate income by category
                const categories = {
                    'real-estate': 0,
                    'tech': 0,
                    'energy': 0,
                    'commodities': 0,
                    'infrastructure': 0,
                    'vehicles': 0
                };
                
                gameState.market.assets.forEach(asset => {
                    if (asset.owned) {
                        categories[asset.category] += asset.reward;
                    }
                });
                
                // Update income chart
                if (incomeChart) {
                    incomeChart.data.datasets[0].data = [
                        categories['real-estate'],
                        categories['tech'],
                        categories['energy'],
                        categories['commodities'],
                        categories['infrastructure'],
                        categories['vehicles']
                    ];
                    incomeChart.update('none');
                }
                
                // Calculate asset value distribution
                const distribution = {
                    'real-estate': 0,
                    'tech': 0,
                    'energy': 0,
                    'commodities': 0,
                    'infrastructure': 0,
                    'vehicles': 0
                };
                
                gameState.market.assets.forEach(asset => {
                    if (asset.owned) {
                        distribution[asset.category] += asset.price;
                    }
                });
                
                // Update distribution chart
                if (assetDistChart) {
                    assetDistChart.data.datasets[0].data = [
                        distribution['real-estate'],
                        distribution['tech'],
                        distribution['energy'],
                        distribution['commodities'],
                        distribution['infrastructure'],
                        distribution['vehicles']
                    ];
                    assetDistChart.update('none');
                }

                // Update stock chart if visible
                if (stockChart && activeSection === 'stocks') {
                    const selectedSymbol = elements.stockSelector.value;
                    const stock = gameState.stockMarket.stocks[selectedSymbol];
                    if (stock) {
                        stockChart.data.datasets[0].data = stock.history;
                        stockChart.data.labels = Array.from({length: stock.history.length}, (_, i) => `${i}h`);
                        stockChart.update('none');
                    }
                }
            } catch (error) {
                console.error('Failed to update charts:', error);
            }
        }

        // NEW: Add CSS for new features dynamically
        function addDynamicStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .daily-reward {
                    text-align: center;
                    padding: 10px;
                    border: 2px solid rgba(255, 255, 255, 0.1);
                    border-radius: 10px;
                    transition: all 0.3s ease;
                    cursor: pointer;
                }

                .daily-reward.claimed {
                    background: rgba(40, 167, 69, 0.2);
                    border-color: var(--success);
                    color: var(--success);
                }

                .daily-reward.current {
                    background: rgba(255, 193, 7, 0.2);
                    border-color: var(--warning);
                    animation: pulse 2s infinite;
                }

                .daily-reward.available {
                    border-color: var(--primary);
                    background: rgba(110, 69, 226, 0.1);
                }

                @keyframes pulse {
                    0%, 100% { transform: scale(1); }
                    50% { transform: scale(1.05); }
                }

                .reward-day {
                    font-size: 12px;
                    font-weight: 600;
                    margin-bottom: 5px;
                }

                .reward-amount {
                    font-size: 14px;
                    font-weight: 700;
                    color: var(--warning);
                }

                .loan-option {
                    padding: 15px;
                    border: 2px solid rgba(255, 255, 255, 0.1);
                    border-radius: 12px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    text-align: center;
                }

                .loan-option:hover {
                    border-color: rgba(110, 69, 226, 0.5);
                    background: rgba(110, 69, 226, 0.1);
                }

                .loan-option.selected {
                    border-color: var(--primary);
                    background: rgba(110, 69, 226, 0.2);
                }

                .business-option, .insurance-option {
                    transition: all 0.3s ease;
                }

                .business-option:hover:not(.disabled), .insurance-option:hover:not(.disabled) {
                    border-color: var(--primary) !important;
                    background: rgba(110, 69, 226, 0.1);
                    transform: translateY(-2px);
                }

                .business-option.selected, .insurance-option.selected {
                    background: rgba(110, 69, 226, 0.2) !important;
                    transform: translateY(-2px);
                }

                .btn-sm {
                    padding: 5px 10px;
                    font-size: 12px;
                }

                .completed {
                    border-left-color: var(--success) !important;
                    background: rgba(40, 167, 69, 0.05);
                }
            `;
            document.head.appendChild(style);
        }

        // Enhanced daily login check
        function checkDailyLogin() {
            const now = Date.now();
            const lastLogin = gameState.player.quests.daily.lastLogin;
            const daysSinceLastLogin = Math.floor((now - lastLogin) / (24 * 60 * 60 * 1000));

            if (daysSinceLastLogin >= 1) {
                // Reset daily bonus
                gameState.player.quests.daily.bonusClaimed = false;
                gameState.player.quests.daily.lastLogin = now;

                if (daysSinceLastLogin === 1) {
                    // Continue streak
                    showNotification("Welcome Back!", `Daily login streak: ${gameState.player.quests.daily.loginStreak} days! Don't forget to claim your bonus.`);
                } else if (daysSinceLastLogin > 1) {
                    // Reset streak
                    gameState.player.quests.daily.loginStreak = 1;
                    showNotification("Login Streak Reset", "Your login streak has been reset. Start building it up again!", "warning");
                }
            }
        }

        // NEW: Update stock modal with real-time calculations
        function updateStockModal() {
            const symbol = elements.stockSymbolSelect.value;
            const shares = parseInt(elements.shareQuantity.value) || 0;
            const stock = gameState.stockMarket.stocks[symbol];
            
            if (stock && shares > 0) {
                const totalCost = stock.price * shares;
                const commission = totalCost * 0.02;
                const finalCost = totalCost + commission;
                
                elements.currentStockPrice.textContent = `$${stock.price.toFixed(2)}`;
                elements.totalStockCost.textContent = `$${formatCurrency(totalCost)}`;
                elements.stockCommission.textContent = `$${formatCurrency(commission)}`;
                
                elements.confirmStockBtn.disabled = gameState.player.cash < finalCost;
            } else {
                elements.currentStockPrice.textContent = '$0.00';
                elements.totalStockCost.textContent = '$0.00';
                elements.stockCommission.textContent = '$0.00';
                elements.confirmStockBtn.disabled = true;
            }
        }

        // NEW: Global functions for onclick handlers
        window.upgradeBusiness = upgradeBusiness;
        window.executeTrade = executeTrade;
        window.cancelTrade = function(tradeId) {
            const tradeIndex = gameState.tradingHub.activeTrades.findIndex(t => t.id === tradeId);
            if (tradeIndex > -1) {
                const trade = gameState.tradingHub.activeTrades[tradeIndex];
                
                // Return asset to seller
                const asset = gameState.market.assets.find(a => a.id === trade.assetId);
                asset.owned = true;
                gameState.player.assets.push(trade.assetId);
                
                // Remove from active trades
                gameState.tradingHub.activeTrades.splice(tradeIndex, 1);
                
                updateNetWorth();
                updateUI();
                saveGame();
                
                showNotification("Trade Cancelled", `Your ${trade.assetName} trade has been cancelled.`);
            }
        };
        window.sellStocks = sellStocks;
        window.claimQuestReward = claimQuestReward;
        window.buyInsurance = buyInsurance;

        // Start the enhanced game with all features
        document.addEventListener('DOMContentLoaded', function() {
            // Add dynamic styles
            addDynamicStyles();
            
            // Initialize the game
            initGame();
            
            // Check daily login
            checkDailyLogin();
            
            // Show enhanced welcome message
            setTimeout(() => {
                showNotification("Welcome to AssetMaster Pro Elite", "The ultimate investment empire simulator! Explore stocks, trading, businesses, quests, and insurance. Build your financial dynasty!");
            }, 1500);
            
            // Show feature highlights for new players
            setTimeout(() => {
                if (gameState.player.salaryCount === 0) {
                    showNotification("New Features Available", "ðŸ”¥ Stock Market ðŸ“ˆ Player Trading ðŸ¢ Business Empire ðŸŽ¯ Daily Quests ðŸ›¡ï¸ Insurance System", "info");
                }
            }, 8000);
        });

        // Enhanced error handling and recovery
        window.addEventListener('error', function(e) {
            console.error('Game Error:', e.error);
            showNotification("Game Error", "An error occurred. Your progress has been saved. Please refresh if issues persist.", "error");
            
            // Emergency save
            try {
                saveGame();
            } catch (saveError) {
                console.error('Emergency save failed:', saveError);
            }
        });

        // Handle page visibility changes for pause/resume
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Page is hidden, save game
                saveGame();
                console.log('Game paused and saved');
            } else {
                // Page is visible again, update timers
                const now = Date.now();
                const timeDiff = (now - gameState.player.lastUpdate) / 1000;
                
                // Apply offline progress (limited to prevent exploitation)
                if (timeDiff > 60 && timeDiff < 86400) { // Between 1 minute and 24 hours
                    const offlineEarnings = Math.min(timeDiff * 10, 100000); // Max $100K offline
                    if (offlineEarnings > 0) {
                        gameState.player.cash += offlineEarnings;
                        gameState.player.stats.lifetimeEarnings += offlineEarnings;
                        updateNetWorth();
                        updateUI();
                        showNotification("Offline Earnings", `You earned $${formatCurrency(offlineEarnings)} while away!`);
                    }
                }
                
                console.log('Game resumed');
            }
        });

        // Final console message
        console.log(`
        ðŸŽ® AssetMaster Pro Elite - Advanced Investment Simulator
        =====================================================
        
        ðŸ”¥ NEW FEATURES:
        â€¢ ðŸ“ˆ Stock Market with real-time trading
        â€¢ ðŸ¤ Player-to-Player Trading Hub  
        â€¢ ðŸ¢ Business Empire Management
        â€¢ ðŸŽ¯ Daily Quests & Achievement System
        â€¢ ðŸ›¡ï¸ Insurance & Risk Management
        â€¢ ðŸ“Š Enhanced Analytics & Charts
        â€¢ â° 10-minute Research Point Generation
        
        ðŸ’¡ TIPS:
        â€¢ Diversify your portfolio across assets, stocks, and businesses
        â€¢ Complete daily quests for bonus rewards
        â€¢ Use insurance to protect against market crashes
        â€¢ Trade with other players for rare assets
        â€¢ Build businesses for passive income
        â€¢ Check the stock market for opportunities
        
        ðŸŽ® Have fun building your financial empire!
        `);

    </script>
</body>
</html>